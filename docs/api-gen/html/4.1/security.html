<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>wCMF 4.1: Security</title>
  <meta name="generator" content="Doxygen 1.8.17"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A MDSD framework for building reliable, maintainable and extendable web applications with PHP">
  <meta name="keywords" content="PHP, web application framework, model driven development">
  <meta name="author" content="wemove digital solutions">
  <link rel="shortcut icon" href="theme/images/favicon.ico">
  <script src="jquery.js"></script>
  <script src="theme/vendor/popper/popper.min.js"></script>
  <script src="theme/vendor/bootstrap/js/bootstrap.min.js"></script>
  <link href="theme/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="theme/vendor/fontawesome/css/all.min.css" rel="stylesheet">
  <script src="theme/vendor/bootstrap-toc/bootstrap-toc.min.js"></script>
  <link href="theme/vendor/bootstrap-toc/bootstrap-toc.min.css" rel="stylesheet">
  <script src="theme/vendor/bootstrap3-typeahead/bootstrap3-typeahead.min.js"></script>
  <script src="theme/vendor/highlight/highlight.pack.js"></script>
  <link href="theme/vendor/highlight/styles/solarized-dark.css" rel="stylesheet">
  <script src="theme/js/application.js"></script>
  <script src="dynsections.js"></script>
  <link href="theme/css/style.css" rel="stylesheet">
</head>
<body data-spy="scroll" data-target="#toc">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <a class="navbar-brand" href="index.html">wCMF 4.1</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggler" aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarToggler">
    <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="guidesDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="far fa-hand-point-right"></i> Guides <b class="caret"></b>
        </a>
        <div class="dropdown-menu" aria-labelledby="guidesDropdownMenuLink">
          <a class="dropdown-item" href="gettingstarted.html">Getting started</a>
          <a class="dropdown-item" href="architecture.html">Architecture</a>
          <a class="dropdown-item" href="model.html">Model</a>
          <a class="dropdown-item" href="persistence.html">Persistence</a>
          <a class="dropdown-item" href="presentation.html">Presentation</a>
          <a class="dropdown-item" href="configuration.html">Configuration</a>
          <a class="dropdown-item" href="security.html">Security</a>
          <a class="dropdown-item" href="i18n_l10n.html">I18n & l10n</a>
          <a class="dropdown-item" href="tests.html">Tests</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="versionsDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-tags"></i> Versions <b class="caret"></b>
        </a>
        <div class="dropdown-menu" aria-labelledby="versionsDropdownMenuLink">
          <a class="dropdown-item" href="4.1/index.html">4.1.x</a>
          <a class="dropdown-item" href="4.0/index.html">4.0.x</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="apiDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-file-alt"></i> API <b class="caret"></b>
        </a>
        <div class="dropdown-menu" aria-labelledby="apiDropdownMenuLink">
          <a class="dropdown-item" href="annotated.html">Classes</a>
          <a class="dropdown-item" href="hierarchy.html">Hierarchy</a>
        </div>
      </li>
      <li class="nav-item"><a class="nav-link" href="https://github.com/iherwig/wcmf"><i class="fab fa-github"></i> Code</a></li>
      <li class="nav-item"><a class="nav-link" href="support.html"><i class="fas fa-life-ring"></i> Support</a></li>
    </ul>
    <form class="form-inline my-2 my-lg-0">
      <input id="search-field" class="form-control mr-sm-2" type="search" placeholder="Search API" disabled>
    </form>
  </div>
</nav>
<a class="anchor" id="top"></a>
<div class="content" id="content">
  <div class="container">
    <div class="row mt-4">
      <div id="toc-container" class="col-lg-3 d-none d-lg-block d-none">
        <nav id="toc" class="sticky-top"></nav>
      </div>
      <div id="content-container" class="col-md-12 col-lg-12">
        <div>
<!-- end header part --><!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
//var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Security </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="has-toc"></div><h1><a class="anchor" id="sec_main"></a>
Security</h1>
<p>Two key aspects of securing an application are <em>authentication</em> and <em>authorization</em>. While <b>authentication</b> is the process of verifying the identity of a user, <b>authorization</b> means determining if the user is allowed to do what he or she is about to do. That implies that authentication is a precondition for authorization. Input <b>validation and filtering</b> is another aspect, which is especially important in web applications.</p>
<h2><a class="anchor" id="sec_users_roles"></a>
Users and Roles</h2>
<p>Users are essential for an authentication system. In wCMF users are represented as instances of classes implementing the <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1principal_1_1_user.html"><code>User</code></a> interface. Since wCMF's authorization system is role based, users are organized in roles. Role classes implement the <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1principal_1_1_role.html"><code>Role</code></a> interface. A user could have multiple roles, while multiple users could have the same role.</p>
<p>The concrete implementations of these interfaces are configured in <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1principal_1_1_principal_factory.html"><code>PrincipalFactory</code></a>.</p>
<h2><a class="anchor" id="sec_authentication"></a>
Authentication</h2>
<p>In wCMF authentication is handled by implementations of <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1_authentication_manager.html"><code>AuthenticationManager</code></a>.</p>
<p>By default <a class="el" href="classwcmf_1_1lib_1_1security_1_1impl_1_1_default_authentication_manager.html"><code>DefaultAuthenticationManager</code></a> is used. It implements a <b>login/password</b> based authentication procedure by matching the given user credentials against existing <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1principal_1_1_user.html"><code>User</code></a> instances. These instances are provided by implementations of <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1principal_1_1_principal_factory.html"><code>PrincipalFactory</code></a>.</p>
<p>The following code demonstrates the authentication process as implemented in <a class="el" href="classwcmf_1_1application_1_1controller_1_1_login_controller.html"><code>LoginController</code></a>:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// get the user credentials from the request</span></div>
<div class="line">$login = $request-&gt;getValue(<span class="stringliteral">&#39;user&#39;</span>);</div>
<div class="line">$password = $request-&gt;getValue(<span class="stringliteral">&#39;password&#39;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">  <span class="comment">// try to login using the credentials</span></div>
<div class="line">  $authUser = $this-&gt;_authenticationManager-&gt;login([</div>
<div class="line">    <span class="stringliteral">&#39;login&#39;</span> =&gt; $login,</div>
<div class="line">    <span class="stringliteral">&#39;password&#39;</span> =&gt; $password</div>
<div class="line">  ]);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (Exception $ex) {</div>
<div class="line">  Log::error(<span class="stringliteral">&quot;Could not log in: &quot;</span>.$ex, __CLASS__);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// set the authenticated user in the session</span></div>
<div class="line"><span class="keywordflow">if</span> ($authUser) {</div>
<div class="line">  <span class="comment">// login succeeded</span></div>
<div class="line">  $session-&gt;setAuthUser($authUser-&gt;getLogin());</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div><dl class="section note"><dt>Note</dt><dd>The login of the user, that is associated with the current session - the <em>current user</em> - is obtained using the <a class="el" href="interfacewcmf_1_1lib_1_1core_1_1_session.html#a687dba7af92a5d45f6363b17fe941ff7"><code>Session::getAuthUser</code></a> method. Before successful authentication, this login is <a class="el" href="classwcmf_1_1lib_1_1security_1_1principal_1_1impl_1_1_anonymous_user.html#ab9e8cd5c2d042df93eb00fad37997ff6"><code>AnonymousUser::USER_GROUP_NAME</code></a>.</dd></dl>
<p>The configuration of the authentication process in the <a class="el" href="gettingstarted.html#app">default application</a> looks like the following:</p>
<div class="ini"> <div class="fragment"><div class="line">[AuthenticationManager]</div>
<div class="line">__class = wcmf\lib\security\impl\DefaultAuthenticationManager</div>
<div class="line">principalFactory = $principalFactory</div>
<div class="line"> </div>
<div class="line">[PrincipalFactory]</div>
<div class="line">__class = wcmf\lib\security\principal\impl\DefaultPrincipalFactory</div>
<div class="line">userType = app.src.model.wcmf.User</div>
<div class="line">roleType = app.src.model.wcmf.Role</div>
</div><!-- fragment --></div><div class="ini"></div><p>Since <a class="el" href="classwcmf_1_1lib_1_1security_1_1principal_1_1impl_1_1_default_principal_factory.html"><code>DefaultPrincipalFactory</code></a> retrieves user instances from the storage, it needs to configured with the appropriate entity types. If required, the default user type can be replaced by custom implementations of <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1principal_1_1_user.html"><code>User</code></a>.</p>
<h2><a class="anchor" id="sec_authorization"></a>
Authorization</h2>
<p>The purpose of authorization is controlling access to application resources, which could be controllers or entity instances. To establish <b>access control</b>, rules have to be defined in the first place and enforced afterwards.</p>
<h3><a class="anchor" id="sec_perm"></a>
Permissions</h3>
<p>Access control rules are expressed as <em>permissions</em>. Permissions are either granted or denied to a role (see <a class="el" href="security.html#sec_users_roles">Users and Roles</a>).</p>
<p>A permission definition in wCMF consists of two parts:</p>
<ul>
<li>The <b>permission subject</b> is a combination of a <em>resource</em>, a <em>context</em> and an <em>action</em> and the notation is the same as for action keys (see <a class="el" href="architecture.html#arch_actionkey">Action Key</a>), except that the <em>controller</em> value is an arbitrary resource.</li>
<li>The <b>involved roles</b> are listed space-separated and each one is prepended with a <em>modifier</em> (<em>+</em> for granting and <em>-</em> for denying).</li>
</ul>
<p>The following code illustrates the <b>format</b>:</p>
<div class="ini"> <div class="fragment"><div class="line">resource?context?action = +allowedRole -deniedRole ...</div>
</div><!-- fragment --></div><div class="ini"></div><h4><a class="anchor" id="autotoc_md8"></a>
Implicit denial</h4>
<p>Roles that are not listed in the permission are denied per default. The wildcard character (<em>*</em>) is used to define the permission for all roles that are not explicitly listed.</p>
<p>The following code grants the permission only to <em>allowedRole</em></p>
<div class="ini"> <div class="fragment"><div class="line">resource?context?action = +allowedRole -*</div>
</div><!-- fragment --></div><div class="ini"></div><p>and is equivalent to</p>
<div class="ini"> <div class="fragment"><div class="line">resource?context?action = +allowedRole</div>
</div><!-- fragment --></div><div class="ini"></div><h4><a class="anchor" id="autotoc_md9"></a>
Default policy</h4>
<p>If no permissions are defined on a resource, a <em>default policy</em> will be applied by default. <a class="el" href="classwcmf_1_1lib_1_1security_1_1impl_1_1_abstract_permission_manager.html"><code>AbstractPermissionManager</code></a> implements the default policy as follows:</p>
<ul>
<li>If the current user is <b>not authorized</b>, the default policy denies all actions</li>
<li>If the current user is <b>authorized</b>, the default policy allows all actions</li>
</ul>
<p>The <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1_permission_manager.html#a8ebc7db3080fc61b83337433c78e35be"><code>PermissionManager::authorize</code></a> method allows to ignore the default policy by passing <code>false</code> as the <code>$applyDefaultPolicy</code> parameter, in which case the method returns null, if no permissions are defined for the resource.</p>
<h4><a class="anchor" id="autotoc_md10"></a>
Operator precedence</h4>
<p>Granted roles are evaluated before denied ones. That means that the following code grants the permission to a user who has both roles (<em>allowedRole</em> and <em>deniedRole</em>) although the permission is denied for one of the roles.</p>
<div class="ini"> <div class="fragment"><div class="line">resource?context?action = +allowedRole -deniedRole</div>
</div><!-- fragment --></div><div class="ini"></div><h4><a class="anchor" id="autotoc_md11"></a>
Built-in resources</h4>
<p>The resource value could be set to any string to implement custom application specific permissions.</p>
<p>Besides this, wCMF uses the following built-in resources:</p>
<ul>
<li><em>Controller</em> to restrict access on execution of a controller (e.g. <code>wcmf\application\controller\SaveController</code>)</li>
<li><em>Entity type</em> to restrict access on all instances of an entity type (e.g. <code>app.src.model.wcmf.User</code>)</li>
<li><em>Entity property</em> to restrict access on a certain property of an entity type (e.g. <code>app.src.model.wcmf.User.login</code>)</li>
<li><em>Entity instance</em> to restrict access on one entity instance (e.g. <code>app.src.model.wcmf.User:123</code>)</li>
<li><em>Entity instance propery</em> to restrict access on a certain property of one entity instance (e.g. <code>app.src.model.wcmf.User:123.login</code>)</li>
<li><em>Media</em> to restrict access to file resources (e.g. <code>media:/folderA??hidden</code>)</li>
</ul>
<p>The <b>actions for the persistency related resources</b> are properties of <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_persistence_action.html"><code>PersistenceAction</code></a>, e.g. <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_persistence_action.html#add302975378da047de904daa059a332b"><code>PersistenceAction::READ</code></a>. While all actions can be applied to instances, for properties only <em>read</em> and <em>update</em> are taken into account.</p>
<dl class="section note"><dt>Note</dt><dd><b>Entity relations</b> are treated like entity properties, which means that read and update access can be restricted.</dd></dl>
<p>The <b>actions for the file related resources</b> are <em>read</em>, <em>write</em>, <em>locked</em> (read only) and <em>hidden</em>.</p>
<h4><a class="anchor" id="autotoc_md12"></a>
Dynamic roles</h4>
<p>Besides assigning <em>static roles</em> to users, it's sometimes useful to have roles, that evaluate dynamically in the current context (<em>requested resource</em>, <em>user</em> and <em>action</em>). With these so called <em>dynamic roles</em> it is for example possible to assign permissions to the creator of an instance or realize date/time based permissions.</p>
<p>Dynamic roles implement the <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1principal_1_1_dynamic_role.html"><code>DynamicRole</code></a> interface and are defined in the <code>DynamicRoles</code> configuration section.</p>
<p>The following example shows the configuration of the <a class="el" href="classwcmf_1_1lib_1_1security_1_1principal_1_1impl_1_1_creator_role.html"><code>CreatorRole</code></a> in the <a class="el" href="gettingstarted.html#app">default application</a>:.</p>
<div class="ini"> <div class="fragment"><div class="line">[DynamicRoles]</div>
<div class="line">creator = $creatorRole</div>
<div class="line"> </div>
<div class="line">[CreatorRole]</div>
<div class="line">__class = wcmf\lib\security\principal\impl\CreatorRole</div>
</div><!-- fragment --></div><div class="ini"></div><dl class="section note"><dt>Note</dt><dd>Dynamic roles are checked before static role assignments. That means you could define a dynamic role with the same name as a static role and add custom matching code.</dd></dl>
<h4><a class="anchor" id="autotoc_md13"></a>
Permission inheritance</h4>
<p>Permissions on <b>entity instances</b> are passed to child entities in a <em>composite relation</em> (see <a class="el" href="model.html#model_associations">Associations</a>). The following image illustrates this:</p>
<div class="image">
<img src="permission-inheritance.png" alt=""/>
<div class="caption">
Permission inheritance</div></div>
<p>If access to the <code>Book</code> instance <em>Book A</em> is restricted for one role, the same restriction also applies for the <code>Chapter</code> instances belonging to it (<em>Chapter A1</em>, <em>Chapter A2</em>). An inherited access restriction can be removed by explicitly granting the permission on the object in question.</p>
<h4><a class="anchor" id="autotoc_md14"></a>
Examples</h4>
<p>The following code shows some permission examples:</p>
<div class="ini"> <div class="fragment"><div class="line"><span class="preprocessor"># tester role is not allowed to update any authors except for the specified one</span></div>
<div class="line"><span class="preprocessor"># tester role is not allowed to update any authors stage attribute</span></div>
<div class="line">app.src.model.Author??update = -tester</div>
<div class="line">app.src.model.Author:111??update = +tester</div>
<div class="line">app.src.model.Author.stage??update = +administrators</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># tester role is not allowed to update any publishers name except for the specified one</span></div>
<div class="line"><span class="preprocessor"># tester role is not allowed to update any authors stage attribute</span></div>
<div class="line">app.src.model.Publisher.name??update = -tester</div>
<div class="line">app.src.model.Publisher:111.name??update = +tester</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># tester role is not allowed to read any book name except for the specified one</span></div>
<div class="line">app.src.model.Book??read = -tester</div>
<div class="line">app.src.model.Book:111??read = +tester</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># tester is not allowed to read chapter 111 and due to inheritance also not sub chapter 222,</span></div>
<div class="line"><span class="preprocessor"># and sub sub chapter 333, sub chapter 555 explicitly allowed and due to inheritance</span></div>
<div class="line"><span class="preprocessor"># also sub sub chapter 666</span></div>
<div class="line">app.src.model.Chapter:111??read = -tester +administrators</div>
<div class="line">app.src.model.Chapter:555??read = +tester +administrators</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># tester role is not allowed to execute SaveController</span></div>
<div class="line">wcmf\application\controller\SaveController?? = -tester</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># the tmp directory is hidden for everyone</span></div>
<div class="line"><span class="preprocessor"># only administrators can rename or delete the uploads directory</span></div>
<div class="line">media:/tmp??hidden = +*</div>
<div class="line">media:/uploads??locked = -administrators +*</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># custom permissions</span></div>
<div class="line">customPermission??start = +tester</div>
<div class="line">customPermission??stop = -tester</div>
</div><!-- fragment --></div><div class="ini"></div><h3><a class="anchor" id="sec_perm_manage"></a>
Permission management</h3>
<p>Permission management includes <em>creation</em>, <em>modification</em> and <em>deletion</em> of permissions as well as handling <em>authorization requests</em>. In an wCMF application an instance of <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1_permission_manager.html"><code>PermissionManager</code></a> is used for these tasks. It is configured in the <code>PermissionManager</code> configuration section.</p>
<p>Generally there are two kinds of permissions to be defined in an application.</p>
<ul>
<li><em>Static permissions</em> are already known when the application is designed, e.g. restriction to entity types or controllers. Since these permissions are not likely to be changed by application users, they can be stored in the application configuration.</li>
<li><em>Dynamic permissions</em> are defined on the application data. These permissions will be set when the appropriate data is created. To allow application users to change these permissions they are typically stored in the database.</li>
</ul>
<p>Different permission types require different ways of permission management, particularly regarding storing permissions. To support this wCMF provides several implementations of the <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1_permission_manager.html"><code>PermissionManager</code></a> interface:</p>
<ul>
<li><a class="el" href="classwcmf_1_1lib_1_1security_1_1impl_1_1_static_permission_manager.html"><code>StaticPermissionManager</code></a> is used to retrieve permissions from the application configuration. The permissions are stored in the <code>Authorization</code> configuration section like shown in the following code:</li>
</ul>
<div class="ini"> <div class="fragment"><div class="line">[Authorization]</div>
<div class="line">??login = +*</div>
<div class="line">??logout = +*</div>
<div class="line">??checkPermissions = +*</div>
<div class="line">??checkPermissionsOfUser = +administrators</div>
<div class="line">app.src.model.wcmf.User??read = +administrators</div>
<div class="line">app.src.model.wcmf.User??update = +administrators</div>
<div class="line">app.src.model.wcmf.User??<span class="keyword">delete</span> = +administrators</div>
<div class="line">app.src.model.wcmf.User??create = +administrators</div>
</div><!-- fragment --></div><div class="ini"></div><ul>
<li><a class="el" href="classwcmf_1_1lib_1_1security_1_1impl_1_1_default_permission_manager.html"><code>DefaultPermissionManager</code></a> handles permissions that are stored in the database. The entity type that actually stores the permissions is required to have a <em>resource</em>, <em>context</em>, <em>action</em> and <em>roles</em> attribute and is defined in the application configuration. The following lines are taken from the configuration of the <a class="el" href="gettingstarted.html#app">default application</a>:</li>
</ul>
<div class="ini"> <div class="fragment"><div class="line">[DefaultPermissionManager]</div>
<div class="line">__class = wcmf\lib\security\impl\DefaultPermissionManager</div>
<div class="line">permissionType = app.src.model.wcmf.Permission</div>
</div><!-- fragment --></div><div class="ini"></div><ul>
<li><a class="el" href="classwcmf_1_1lib_1_1security_1_1impl_1_1_chained_permission_manager.html"><code>ChainedPermissionManager</code></a> is used to combine different <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1_permission_manager.html"><code>PermissionManager</code></a> instances. When asked for authorization, it delegates the request to all it's managers, while creation, modification and deletion of permissions is always handled by the first contained manager. An example configuration of this manager is shown in the code below:</li>
</ul>
<div class="ini"> <div class="fragment"><div class="line">[PermissionManager]</div>
<div class="line">__class = wcmf\lib\security\impl\ChainedPermissionManager</div>
<div class="line">managers = {$defaultPermissionManager, $staticPermissionManager}</div>
<div class="line"> </div>
<div class="line">[DefaultPermissionManager]</div>
<div class="line">__class = wcmf\lib\security\impl\DefaultPermissionManager</div>
<div class="line">permissionType = app.src.model.wcmf.Permission</div>
<div class="line"> </div>
<div class="line">[StaticPermissionManager]</div>
<div class="line">__class = wcmf\lib\security\impl\StaticPermissionManager</div>
</div><!-- fragment --></div><div class="ini"></div><ul>
<li><a class="el" href="classwcmf_1_1lib_1_1security_1_1impl_1_1_null_permission_manager.html"><code>NullPermissionManager</code></a> acts like there is no permission manager and is merely used for testing.</li>
</ul>
<p>All implementations inherit from <a class="el" href="classwcmf_1_1lib_1_1security_1_1impl_1_1_abstract_permission_manager.html"><code>AbstractPermissionManager</code></a>, which already provides most of parts for handling authorization requests.</p>
<h4><a class="anchor" id="sec_perm_temp"></a>
Temporary permissions</h4>
<p>There are situations, where a piece of code requires a certain permission in the context of the current user, which is not possible to grant throughout the whole application. For example, if a user wants to sign in to the application, <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1principal_1_1_principal_factory.html"><code>PrincipalFactory</code></a> needs to provide a user instance although the anonymous user is not allowed to read user instances. To accomplish this, <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1_permission_manager.html"><code>PermissionManager</code></a> allows to set a transient, temporary permission like in the following example:</p>
<div class="php"> <div class="fragment"><div class="line">$permissionManager = ObjectFactory::getInstance(<span class="stringliteral">&#39;permissionManager&#39;</span>);</div>
<div class="line">$persistenceFacade = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>);</div>
<div class="line">$userType = <span class="stringliteral">&#39;app.src.model.wcmf.User&#39;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// set up a temporary permission to read the user instance for the given login</span></div>
<div class="line">$permissionManager-&gt;addTempPermission($userType, <span class="stringliteral">&#39;&#39;</span>, PersistenceAction::READ);</div>
<div class="line"> </div>
<div class="line">$user = $persistenceFacade-&gt;loadFirstObject($userType, BuildDepth::SINGLE, [</div>
<div class="line">            <span class="keyword">new</span> Criteria($userType, <span class="stringliteral">&#39;login&#39;</span>, <span class="charliteral">&#39;=&#39;</span>, $login)</div>
<div class="line">        ], <span class="keyword">null</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// remove the temporary permission</span></div>
<div class="line">$permissionManager-&gt;removeTempPermission($userType, <span class="stringliteral">&#39;&#39;</span>, PersistenceAction::READ);</div>
</div><!-- fragment --></div><div class="php"></div><h3><a class="anchor" id="sec_perm_check"></a>
Checking permissions</h3>
<p>To test, if a user has the permission to access a resource in the requested way the method <a class="el" href="interfacewcmf_1_1lib_1_1security_1_1_permission_manager.html#a8ebc7db3080fc61b83337433c78e35be"><code>PermissionManager::authorize</code></a> is used. It returns a boolean value indicating whether the user is authorized or not.</p>
<p>The following code shows how to determine, if the current user is allowed to read the given object:</p>
<div class="php"> <div class="fragment"><div class="line">$canRead = $permissionManager-&gt;authorize($object-&gt;getOID(), <span class="stringliteral">&#39;&#39;</span>, PersistenceAction::READ);</div>
</div><!-- fragment --></div><div class="php"></div><h4><a class="anchor" id="sec_perm_default_policies"></a>
Default policies</h4>
<p>Default policies answer the question, what happens if <b>no permission</b> is defined on a requested resource. These rules depend on the authentication status of the current user and are defined in <a class="el" href="classwcmf_1_1lib_1_1security_1_1impl_1_1_abstract_permission_manager.html"><code>AbstractPermissionManager</code></a> as follows:</p>
<ul>
<li><em>Not authenticated</em>: Resource is <em>not accessible</em></li>
<li><em>Authenticated</em>: Resource is <em>accessible</em></li>
</ul>
<h2><a class="anchor" id="sec_session"></a>
Sessions</h2>
<p>wCMF provides the following <a class="el" href="interfacewcmf_1_1lib_1_1core_1_1_session.html"><code>Session</code></a> implementations:</p>
<ul>
<li><a class="el" href="classwcmf_1_1lib_1_1core_1_1impl_1_1_default_session.html"><code>DefaultSession</code></a> is a session that uses PHP's default server side session implementation in combination with a session cookie.</li>
<li><a class="el" href="classwcmf_1_1lib_1_1core_1_1impl_1_1_auth_token_session.html"><code>AuthTokenSession</code></a> additionally requires clients to send an <code>X-Auth-Token</code> request header.</li>
<li><a class="el" href="classwcmf_1_1lib_1_1core_1_1impl_1_1_client_side_session.html"><code>ClientSideSession</code></a> has no server state as it stores the data in cookies.</li>
</ul>
<h2><a class="anchor" id="sec_input"></a>
Input</h2>
<p>Generally all external input sent to the application should be considered harmful.</p>
<p>In PHP this input is stored in so called <em>Superglobals</em>, e.g. <em>$_GET</em>, <em>$_POST</em>, <em>$_FILES</em>. To avoid using these global variables directly in code, wCMF encapsulates them in the <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_request.html"><code>Request</code></a> instance and makes them available through the <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_controller_message.html#a2a9456b969a23e4fa8d6d6ee6b475cf3"><code>Request::getValue</code></a> method. Besides the variable name this method defines the following optional parameters:</p>
<ul>
<li><code>$default</code> default value if the value is not contained in the request</li>
<li><code>$validateDesc</code> description of the validation to be applied to the value</li>
</ul>
<p>The <code>$validateDesc</code> parameter is passed to the <a class="el" href="classwcmf_1_1lib_1_1validation_1_1_validator.html#a53caf4e6a104095444452928dea631ad"><code>Validator::validate</code></a> method and <code>null</code> is returned if validation fails.</p>
<p>The following code demonstrates the usage:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// validate an email value</span></div>
<div class="line">$email = $request-&gt;getValue(<span class="stringliteral">&#39;email&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;filter:{&quot;type&quot;:&quot;validate_email&quot;}&#39;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// validate a date using a regular expression and return the current date on failure</span></div>
<div class="line">$today = date(<span class="stringliteral">&#39;Y-m-d&#39;</span>);</div>
<div class="line">$date = $request-&gt;getValue(<span class="stringliteral">&#39;date&#39;</span>, $today, <span class="stringliteral">&#39;regex:{&quot;pattern&quot;:&quot;/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/&quot;}&#39;</span>);</div>
</div><!-- fragment --></div><div class="php"></div><p>For more information about validation see <a class="el" href="persistence.html#pers_validation">Validation</a>.</p>
<h3><a class="anchor" id="sec_input_csrf"></a>
CSRF protection</h3>
<p>To avoid <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery">CSRF</a> vulnerabilities in a web application, forms are usually protected by using <em>CSRF tokens</em>. The <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_controller.html#aa4fdced53ec24fdf64a5e273b14285ed"><code>Controller::generateCsrfToken</code></a> method is used to generate a unique token value for each form display. The token is validated by using the <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_controller.html#a1cf0cb32ffd3b2c17dc62ef95b195b97"><code>Controller::validateCsrfToken</code></a> method when the form is submitted. For proper identification, tokens are referenced by a name (e.g. the form's name) which is passed to these methods.</p>
<p>The following example demonstrates the usage of these methods.</p>
<p>A new token value is generated each time the form is displayed:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="keyword">class </span>UserController {</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">public</span> <span class="keyword">function</span> render() {</div>
<div class="line"> </div>
<div class="line">    $this-&gt;generateCsrfToken(<span class="stringliteral">&#39;login&#39;</span>);</div>
<div class="line"> </div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div><p>This creates the <code>csrf_token</code> response variable. The variable is used to add the token as a hidden field to the form:</p>
<div class="html"> <div class="fragment"><div class="line">&lt;input type=<span class="stringliteral">&quot;hidden&quot;</span> name=<span class="stringliteral">&quot;csrf_token&quot;</span> value=<span class="stringliteral">&quot;{$csrf_token}&quot;</span>&gt;</div>
</div><!-- fragment --></div><div class="html"></div><p>After form submission the controller validates the token and acts appropriately:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="keyword">class </span>UserController {</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">public</span> <span class="keyword">function</span> login() {</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!$this-&gt;validateCsrfToken(<span class="stringliteral">&#39;login&#39;</span>)) {</div>
<div class="line">      <span class="comment">// error</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="comment">// do login</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
      </div>
    </div>
  </div>
</div>
<hr>
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <small>&copy; 2020 <a href="http://www.wemove.com" target="_blank">wemove digital solutions</a><br>
          Generated on Mon Dec 21 2020 22:40:28 for wCMF by &#160;<a href="http://www.doxygen.org/index.html" target="_blank">doxygen</a> 1.8.17</small>
      </div>
    </div>
  </div>
</footer>
<!-- Matomo -->
<script type="text/javascript">
  var _paq = _paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://piwik.wemove.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '7']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><img src="https://piwik.wemove.com/piwik.php?idsite=7&rec=1" style="border:0" alt="" /></noscript>
<!-- End Matomo -->
</body>
</html>
