<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>wCMF 4.0: Presentation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A MDSD framework for building reliable, maintainable and extendable web applications with PHP">
  <meta name="keywords" content="PHP, web application framework, model driven development">
  <meta name="author" content="wemove digital solutions">
  <link rel="shortcut icon" href="theme/images/favicon.ico">
  <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
  <!--[if lt IE 9]>
        <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
  <link href="theme/css/doxstyles.css" rel="stylesheet">
  <script src="jquery.js"></script>
  <script src="theme/bootstrap3/js/bootstrap.min.js"></script>
  <link href="theme/bootstrap3/css/bootstrap.min.css" rel="stylesheet">
  <link href="theme/bootstrap3/css/font-awesome.min.css" rel="stylesheet">
  <script src="theme/js/tocify/jquery.tocify.min.js"></script>
  <link href="theme/js/tocify/jquery.tocify.css" rel="stylesheet">
  <script src="theme/js/doxy-boot.js"></script>
  <script src="theme/js/application.js"></script>
  <script src="dynsections.js"></script>
  <link href="theme/css/syntax.css" rel="stylesheet">
  <link href="theme/css/style.css" rel="stylesheet">
  <script src="search/search.js"></script>
  <script src="search/searchdata.js"></script>
</head>
<body style="min-height: 200px; padding-top: 50px;">
<header class="navbar navbar-inverse navbar-fixed-top bs-docs-nav">
  <div class="container">
    <div class="row">
      <div class="col-md-offset-1 col-sm-offset-0 col-md-10">
        <div class="navbar-header">
          <button class="navbar-toggle" type="button" data-toggle="collapse" data-target=".menu-navbar-collapse">
            <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">wCMF 4.0</a>
        </div>
        <div class="collapse navbar-collapse menu-navbar-collapse" role="navigation">
          <ul class="nav navbar-nav">
            <li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="fa fa-hand-o-right"></i> Guides <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="gettingstarted.html">Getting started</a></li>
                <li><a href="architecture.html">Architecture</a></li>
                <li><a href="model.html">Model</a></li>
                <li><a href="persistence.html">Persistence</a></li>
                <li><a href="presentation.html">Presentation</a></li>
                <li><a href="configuration.html">Configuration</a></li>
                <li><a href="security.html">Security</a></li>
                <li><a href="i18n_l10n.html">I18n & l10n</a></li>
                <li><a href="tests.html">Tests</a></li>
              </ul>
            </li>
            <li class="dropdown"><a href="annotated.html"><i class="fa fa-file-text-o"></i> API</a></li>
            <li><a href="https://github.com/iherwig/wcmf"><i class="fa fa-github"></i> Code</a></li>
            <li><a href="support.html"><i class="fa fa-support"></i> Support</a></li>
          </ul>
          <ul class="nav navbar-nav pull-right">
            <li>
              <div id="MSearchBox">
                <input id="MSearchField" type="text" class="form-control" placeholder="Search API" name="query" onkeyup="searchBox.OnSearchFieldChange(event)">
              </div>
              <div id="MSearchSelect"></div>
              <div id="MSearchClose"></div>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>
<a class="anchor" id="top"></a>
<div class="content" id="content">
  <div class="container">
    <div class="row" style="margin-top: 20px;">
      <div class="col-md-offset-1 col-sm-offset-0 col-md-10 panel panel-default">
       <div>
<!-- end header part --><!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
//var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Presentation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="has-toc"></div><h1><a class="anchor" id="pres_main"></a>
Presentation</h1>
<p>Presentation refers to the part of the application that is visible to the user - the <em>user interface</em> - and the handling of user interaction.</p>
<h2><a class="anchor" id="pres_services"></a>
Services</h2>
<p>The presentation layer usually depends on underlying services like persistency, event handling, caching - just to name a few. These services typically exist as one instance that is created on application startup and is used throughout the whole application lifetime.</p>
<p>The preferred way to get access to a service instance in client code is to set the dependency explicitly or let it be injected, if the instance is not created explicitly (see <a class="el" href="configuration.html#conf_di">Dependency injection</a>). But there are also situations where this is not possible (e.g. a global function that is used by third party code). Since most of these services are registered with <a class="el" href="classwcmf_1_1lib_1_1core_1_1_object_factory.html"><code>ObjectFactory</code></a>, it's <a class="el" href="classwcmf_1_1lib_1_1core_1_1_object_factory.html#a11fc3766874ff733f8c4c7e3fc5152a6"><code>getInstance</code></a> method may be used as a <a href="https://en.wikipedia.org/wiki/Service_locator_pattern">service locator</a>.</p>
<p>The following example shows how to get the persistence service at any code location:</p>
<div class="fragment"><div class="line">$persistenceFacade = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>);</div>
</div><!-- fragment --><h2><a class="anchor" id="pres_application"></a>
Application</h2>
<p>Web applications typically implement a <em>request-response pattern</em>, where a client sends a (<a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a>-)request to the application, which returns a response after processing it. wCMF encapsulates the described procedure inside the <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application.html"><code>Application</code></a> class. The following code demonstrates the usage of this class in the main entry script of the <a class="el" href="gettingstarted.html#app">default application</a>.</p>
<div class="fragment"><div class="line">$application = <span class="keyword">new</span> Application();</div>
<div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">  <span class="comment">// initialize the application</span></div>
<div class="line">  $request = $application-&gt;initialize(<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;cms&#39;</span>);</div>
<div class="line"></div>
<div class="line">  <span class="comment">// run the application</span></div>
<div class="line">  $response = $application-&gt;run($request);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (<a class="code" href="namespace_exception.html">Exception</a> $ex) {</div>
<div class="line">  <span class="keywordflow">try</span> {</div>
<div class="line">    $application-&gt;handleException($ex, isset($request) ? $request : null);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">catch</span> (<a class="code" href="namespace_exception.html">Exception</a> $unhandledEx) {</div>
<div class="line">    echo(<span class="stringliteral">&quot;An unhandled exception occured. Please see log file for details.&quot;</span>);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p>The example shows the three important methods of the <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application.html"><code>Application</code></a> class:</p>
<ul>
<li>The <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application.html#a2d228eaacdd9d0081c99eb16a60fe7b8"><code>initialize</code></a> method is used to <b>setup</b> the <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application.html"><code>Application</code></a>. It returns a <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_request.html"><code>Request</code></a> instance, that may be modified before execution.</li>
<li>The <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application.html#ae40ac2db89d00ceca9183a1e5426b1f9"><code>run</code></a> method is called to <b>execute</b> the given request. The method returns a <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_response.html"><code>Response</code></a> instance, that is not used in this example.</li>
<li>The <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application.html#ad277d25fb9f732225ef51009ab7c1988"><code>handleException</code></a> method is called, if an <b>exception</b> occurs. The method rolls back the database transaction and calls the <em>failure</em> action.</li>
</ul>
<p>The details of request execution are the topic of the next section.</p>
<h2><a class="anchor" id="pres_request"></a>
Request processing</h2>
<p>The <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_request.html"><code>Request</code></a> instance created on initialization of the application provides all information about the incoming HTTP request, that is necessary for execution. Upon execution, the following actions are performed:</p>
<ol type="1">
<li>The <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_request.html"><code>Request</code></a> instance is passed to <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_action_mapper.html"><code>ActionMapper</code></a> for further processing.</li>
<li>The <a class="el" href="architecture.html#arch_actionkey">Action Key</a> is determined from the request parameters.</li>
<li><a class="el" href="interfacewcmf_1_1lib_1_1security_1_1_permission_manager.html"><code>PermissionManager</code></a> is asked to authorize the action key for the current user (see <a class="el" href="security.html#sec_perm_check">Checking permissions</a>).</li>
<li>If authorization is successful, the request data is transformed into the internal application format (see <a class="el" href="presentation.html#pres_format">Formats</a>).</li>
<li>The <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_controller.html"><code>Controller</code></a> instance matching the request is determined (see <a class="el" href="presentation.html#pres_routing">Routing</a>) and executed.</li>
<li>The <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_response.html"><code>Response</code></a> instance is obtained after execution.</li>
<li>The response data is transformed into the requested response format (see <a class="el" href="presentation.html#pres_format">Formats</a>).</li>
<li>Execution returns to step 3, if a valid action key is contained in the response data and terminates, if no action key is found or the response is finalized by calling the method <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_response.html#a705216f429a96fe01fc29a3fefba3858"><code>Response::setFinal</code></a>.</li>
</ol>
<h3><a class="anchor" id="pres_format"></a>
Formats</h3>
<p>wCMF is designed to be able to consume various request formats and produce several response formats. While some clients communicate using <a href="http://en.wikipedia.org/wiki/JSON">JSON</a> format, others might prefer to encode data in <a href="http://en.wikipedia.org/wiki/XML">XML</a>. <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1format_1_1_formatter.html"><code>Formatter</code></a> is used to determine the required format and delegate the actual formatting to the correct <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1format_1_1_format.html"><code>Format</code></a> implementation. wCMF currently provides the following <b>implementations</b>:</p>
<ul>
<li><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1format_1_1impl_1_1_html_format.html"><code>HtmlFormat</code></a> expects all data to be sent as key-value-pairs. Object data are transferred in parameters named <code>value-</code><em>name-oid</em> (e.g. <code>value-title-Book:3</code>). Responses in this format are rendered as HTML views (see <a class="el" href="presentation.html#pres_views">Views</a>).</li>
<li><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1format_1_1impl_1_1_json_format.html"><code>JsonFormat</code></a> handles JSON encoded request data and encodes response data into the same format.</li>
<li><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1format_1_1impl_1_1_soap_format.html"><code>SoapFormat</code></a> is used together with the <a href="http://sourceforge.net/projects/nusoap/">NuSOAP</a> library to implement a SOAP interface.</li>
<li><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1format_1_1impl_1_1_null_format.html"><code>NullFormat</code></a> is used internally, if no formatting is required, e.g. if one controller calls another controller.</li>
</ul>
<p>If not explicitely set, the request and response format is automatically determined from the <b>HTTP headers</b> sent with the request:</p>
<ul>
<li>The <code>Content-Type</code> header defines the <b>request</b> format</li>
<li>The <code>Accept</code> header defines the <b>response</b> format</li>
</ul>
<p>To find the correct format, the <a href="https://www.iana.org/assignments/media-types/media-types.xhtml">Media Type</a> value set in those headers is matched against the mime type of all registered formats (see <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1format_1_1_format.html#ac06e9f7b10fca30eb41e41d4dc108b1c"><code>Format::getMimeType</code></a>).</p>
<p>Formats are defined in the <code>Formats</code> configuration section as shown in the following example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Formats]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;html = $htmlFormat</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;null = $nullFormat</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;[HtmlFormat]</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;__class = wcmf\lib\presentation\format\impl\HtmlFormat</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;[NullFormat]</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;__class = wcmf\lib\presentation\format\impl\NullFormat</div>
</div><!-- fragment --><h3><a class="anchor" id="pres_routing"></a>
Routing</h3>
<p>Routing is the process of selecting the correct <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_controller.html"><code>Controller</code></a> for a given request. wCMF distinguishes between <em>internal</em> and <em>external</em> routing.</p>
<h4><a class="anchor" id="pres_routingint"></a>
Internal routing</h4>
<p>Internal routing takes place after the <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_request.html"><code>Request</code></a> instance is created and initialized. wCMF inspects the <b>action key</b> formed from it's <em>sender</em>, <em>context</em> and <em>action</em> parameters (see <a class="el" href="architecture.html#arch_actionkey">Action Key</a>) to determine the controller to be executed for the request. The mapping of action keys to controllers is defined in the <code>ActionMapping</code> configuration section.</p>
<p>If the executed controller together with the <em>context</em> and <em>action</em> parameters of the response match another action key, the corresponding controller will be executed afterwards. This allows to chain several actions together. If no matching action key is found, the response is returned to the client.</p>
<p>The following code is taken from the <a class="el" href="gettingstarted.html#app">default application</a> configuration and shows the configuration of the indexing process (see <a class="el" href="presentation.html#pres_longrequest">Long running requests</a>):</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[ActionMapping]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;??indexAll = wcmf\application\controller\SearchIndexController</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;wcmf\application\controller\SearchIndexController??continue =</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;                            wcmf\application\controller\SearchIndexController</div>
</div><!-- fragment --><ul>
<li>The first line states that the action <em>indexAll</em> called from <em>any</em> controller and in <em>any</em> context will invoke <a class="el" href="classwcmf_1_1application_1_1controller_1_1_search_index_controller.html"><code>SearchIndexController</code></a>, which will set a state dependent action name on the response (see <a class="el" href="classwcmf_1_1application_1_1controller_1_1_batch_controller.html"><code>BatchController</code></a>).</li>
<li>The second line tells <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_action_mapper.html"><code>ActionMapper</code></a> to re-invoke <a class="el" href="classwcmf_1_1application_1_1controller_1_1_search_index_controller.html"><code>SearchIndexController</code></a>, if it was the last controller and the action is <em>continue</em>. So this action key only matches, if the last controller was <a class="el" href="classwcmf_1_1application_1_1controller_1_1_search_index_controller.html"><code>SearchIndexController</code></a>.</li>
</ul>
<h5>Controller methods</h5>
<p>The previous example maps the action keys to a controller class without specifying a method to be called. In these cases, the framework calls the default method <code>doExecute</code>, which must then be defined in the controller class (see <a class="el" href="presentation.html#pres_controllers">Controllers</a>).</p>
<p>Alternatively a specific <b>controller method</b> to be called may be defined in the action mapping, like illustrated in the following example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[ActionMapping]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;??indexAll = wcmf\application\controller\SearchIndexController::doBegin</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;wcmf\application\controller\SearchIndexController??continue =</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;                            wcmf\application\controller\SearchIndexController::doContinue</div>
</div><!-- fragment --><p>In this case <a class="el" href="classwcmf_1_1application_1_1controller_1_1_search_index_controller.html"><code>SearchIndexController</code></a> would have to define the methods <code>doBegin</code> and <code>doContinue</code> which are called for the appropriate action keys.</p>
<h4><a class="anchor" id="pres_routingext"></a>
External routing</h4>
<p>The mapping of the current <b>request uri</b> to an <b>action key</b> is called external routing. The default mapping logic is implemented in the <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1impl_1_1_default_request.html#a36e0e7579b8ab70ec7690b37dcdfa312"><code>DefaultRequest::initialize</code></a> method. The method matches the <em>path part</em> of the request uri against the entries of the <code>Routes</code> configuration section to find an appropriate action key. Variables declared in path segments will be automatically passed as request parameters.</p>
<p>The following example configuration taken from the <a class="el" href="gettingstarted.html#app">default application</a> illustrates the concept:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Routes]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;/ = action=cms</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;/rest/{language}/{className} = action=restAction&amp;collection=1</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;/rest/{language}/{className}/{id|[0-9]+} = action=restAction&amp;collection=0</div>
</div><!-- fragment --><ul>
<li>The first entry is matched by the root path, which is then mapped to the <em>cms</em> action - corresponding to the action key <em>??cms</em>.</li>
<li>The second entry defines the <em>language</em> and <em>className</em> variables (surrounded by curly braces) and would be matched by the request uris <em>/rest/de/Author</em> or <em>/rest/en/Book</em>. The executed action would be <em>restAction</em>.</li>
<li>The <em>id</em> variable in the third entry must be an integer because of the regular expression constraint <code>[0-9]+</code>.</li>
</ul>
<h5>HTTP methods</h5>
<p>To restrict a path to one or more <b>HTTP methods</b>, they may be added in front of the route definition. In the following example the <em>cms</em> action is only available for the <em>GET</em> method, while the other actions accept <em>GET</em>, <em>POST</em>, <em>PUT</em> and <em>DELETE</em> requests:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Routes]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;GET/ = action=cms</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;GET,POST,PUT,DELETE/rest/{language}/{className} = action=restAction&amp;collection=1</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;GET,POST,PUT,DELETE/rest/{language}/{className}/{id|[0-9]+} = action=restAction&amp;collection=0</div>
</div><!-- fragment --><p>If no method is added to a route, all methods are accepted.</p>
<h2><a class="anchor" id="pres_controllers"></a>
Controllers</h2>
<p>Controllers take the user input from the request and modify the model according to it. As a result a response is created which is presented to the user in a view or any other format. Which controller is executed on a specific request is determined in the routing process (see <a class="el" href="presentation.html#pres_routing">Routing</a>).</p>
<p>wCMF provides <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_controller.html"><code>Controller</code></a> as abstract base class for controller implementations. There are three important methods defined in this class, which are called by <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_action_mapper.html"><code>ActionMapper</code></a> in the following order:</p>
<ol type="1">
<li><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_controller.html#a47a24ac0d700f62a9434d298ade72fb9"><code>Controller::initialize</code></a> is called directly after instantiation of the controller. The current <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_request.html"><code>Request</code></a> and <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_response.html"><code>Response</code></a> instances are passed as parameters and subclasses may override this method to implement task specific initializations.</li>
<li><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_controller.html#a184909dab34698899937d810a9f5d393"><code>Controller::validate</code></a> is called afterwards to check the validity of the request parameters. The default implementation returns <em>true</em> and subclasses are assumed to override this method if necessary to do task specific validations.</li>
<li><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_controller.html#a1df29271eb3c879e6ebf5c9f60ddc806"><code>Controller::execute</code></a> is called finally. This method accepts a parameter, that defines the actual method to be called on the subclass. If the parameter is omitted it defaults to <code>doExecute</code> which must then be defined in the subclass.</li>
</ol>
<h3><a class="anchor" id="pres_errors"></a>
Error handling</h3>
<p>Errors are typically divided into <b>fatal errors</b> and <b>non-fatal errors</b>.</p>
<p>By definition the application is not able to recover from a <em>fatal error</em>, meaning that it's not functioning correctly. An example would be a programming error or a missing vital resource. These errors normally need to be fixed by the application maintainer. In case of <em>non-fatal errors</em> a notice to the user is sufficient in most cases. A typical example would be invalid user input, that can be fixed by the user itself.</p>
<p>In wCMF the following two strategies are recommended for handling these kind of situations:</p>
<ul>
<li>In case of a <b>fatal error</b>, an exception should be thrown. If it is not caught inside the application code, it will bubble up to the main script (usually <em>index.php</em>). In case the application is set up like in the <a class="el" href="presentation.html#pres_application">Application</a> section, the method <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application.html#ad277d25fb9f732225ef51009ab7c1988"><code>Application::handleException</code></a> will be called. This method rolls back the current transaction and calls the <em>failure</em> action, which is executed by <a class="el" href="classwcmf_1_1application_1_1controller_1_1_failure_controller.html"><code>FailureController</code></a> by default.</li>
<li>If a <b>non-fatal error</b> occurs, an instance of <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application_error.html"><code>ApplicationError</code></a> should be created and added to the response using the <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1_controller_message.html#a1713cbae7046bb8f8baa9cac224150ec"><code>Response::addError</code></a> method. The error class provides the <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application_error.html#a7b6de2953b070910660cee9f229bc554"><code>ApplicationError::get</code></a> method to retrieve predefined errors. The following example shows how to signal an invalid <em>type</em> parameter while request validation:</li>
</ul>
<div class="fragment"><div class="line">$response-&gt;addError(ApplicationError::get(<span class="stringliteral">&#39;PARAMETER_INVALID&#39;</span>,</div>
<div class="line">  array(<span class="stringliteral">&#39;invalidParameters&#39;</span> =&gt; array(<span class="stringliteral">&#39;type&#39;</span>))));</div>
</div><!-- fragment --><h3><a class="anchor" id="pres_longrequest"></a>
Long running requests</h3>
<p>There are situations where you want to split a long running process into parts, because it's exceeding memory or time limits or simply to give the user feedback about the progress. By subclassing <a class="el" href="classwcmf_1_1application_1_1controller_1_1_batch_controller.html"><code>BatchController</code></a> the implementation of this behavior is as simple as defining the steps of the process in the <a class="el" href="classwcmf_1_1application_1_1controller_1_1_batch_controller.html#aa969f966d1ab74704cbde9512d281d2c"><code>BatchController::getWorkPackage</code></a> method.</p>
<p><a class="el" href="classwcmf_1_1application_1_1controller_1_1_search_index_controller.html"><code>SearchIndexController</code></a> is an example for a controller implementing a long running process. It is used to create a Lucene search index over all searchable entity objects. The process is split into collecting all object ids and then indexing them. In the final step the index is optimized.</p>
<h2><a class="anchor" id="pres_views"></a>
Views</h2>
<p>Views are used to present application information to the user. In a web application they are typically HTML pages displayed in the browser.</p>
<p>In wCMF the response will be turned into an HTML page, if the <code>Accept</code> HTTP header is set to <em>text/html</em> (see <a class="el" href="presentation.html#pres_format">Formats</a>). The appropriate <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1format_1_1_format.html"><code>Format</code></a> implementation is <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1format_1_1impl_1_1_html_format.html"><code>HtmlFormat</code></a>. It renders the response into a template file using the configured <a class="el" href="interfacewcmf_1_1lib_1_1presentation_1_1view_1_1_view.html"><code>View</code></a> implementation. The format of the template files depends on the chosen that implementation. Since different actions may require different views to be displayed, a mapping of action keys to view templates is defined in the <code>Views</code> configuration section.</p>
<p>The following example shows the configuration of the <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1view_1_1impl_1_1_smarty_view.html"><code>SmartyView</code></a> class and the mapping of action keys to views in the <a class="el" href="gettingstarted.html#app">default application</a>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[View]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;__class = wcmf\lib\presentation\view\impl\SmartyView</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;__shared = false</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;compileCheck = true</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;caching = false</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;cacheLifetime = 3600</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;cacheDir = app/cache/smarty/</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;[Views]</div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;app\src\controller\RootController?? = app/src/views/cms.tpl</div>
</div><!-- fragment --><p>Since the <a class="el" href="gettingstarted.html#app">default application</a> only uses an HTML page to bootstrap the actual <a href="https://dojotoolkit.org/">Dojo</a> application, there is only one view mapping for <code>RootController</code>.</p>
<h3>Device dependent views</h3>
<p><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1format_1_1impl_1_1_html_format.html"><code>HtmlFormat</code></a> allows to provide different versions of a view template. This is especially useful, if you want to deliver device dependent content for the same action key.</p>
<p>To select a specific template version, the value <code>html_tpl_format</code> has to be set on the response instance. E.g. if the template file would be <em>home.tpl</em>, setting the value to <em>mobile</em> would select the template file <em>home-mobile.tpl</em>. If the requested version does not exist, it is ignored and the default template is used (<em>home.tpl</em> in this example).</p>
<h2>Webservice APIs</h2>
<p>Besides the user interface driven <a class="el" href="gettingstarted.html#app">default application</a> wCMF provides APIs for using the application as a <a href="https://en.wikipedia.org/wiki/Web_service">web service</a>. These APIs provide create/read/update/delete (<a href="https://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a>) operations on all entity types.</p>
<h3>RESTful API</h3>
<p>The <a href="https://en.wikipedia.org/wiki/Representational_state_transfer">REST</a>ful interface is implemented in <a class="el" href="classwcmf_1_1application_1_1controller_1_1_r_e_s_t_controller.html"><code>RESTController</code></a>, which basically acts as a facade in front of the application. That means the controller checks the request data only and delegates the actual processing to the action specific controller.</p>
<p>The following example shows the configuration of the RESTful interface in the <a class="el" href="gettingstarted.html#app">default application</a>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Routes]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;/rest/{language}/{className} = action=restAction&amp;collection=1</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;/rest/{language}/{className}/{id|[0-9]+} = action=restAction&amp;collection=0</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;/rest/{language}/{className}/{sourceId|[0-9]+}/{relation} = action=restAction&amp;collection=1</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;/rest/{language}/{className}/{sourceId|[0-9]+}/{relation}/{targetId|[0-9]+} = action=restAction&amp;collection=0</div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;[ActionMapping]</div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;??restAction = wcmf\application\controller\RESTController</div>
</div><!-- fragment --><p>The <code>Routes</code> configuration section defines the urls for the interface. They all call the action <em>restAction</em> internally, which is handled by <a class="el" href="classwcmf_1_1application_1_1controller_1_1_r_e_s_t_controller.html"><code>RESTController</code></a> as defined in the <code>ActionMapping</code> section. For example the english version of the <code>Author</code> instance with id <em>1</em> may be retrieved by making a GET request to the url <em>/rest/en/Author/1</em>.</p>
<h3>SOAP API</h3>
<p>wCMF uses the <a href="http://sourceforge.net/projects/nusoap/">NuSOAP</a> library for implementing the SOAP interface. It consists of the <a class="el" href="classwcmf_1_1lib_1_1service_1_1_soap_server.html"><code>SoapServer</code></a> and <a class="el" href="classwcmf_1_1application_1_1controller_1_1_s_o_a_p_controller.html"><code>SOAPController</code></a> classes. The controller class handles all requests and delegates the processing to the server class. The service description in the <a href="https://en.wikipedia.org/wiki/Web_Services_Description_Language">WSDL</a> format is generated by the code generator into a file called <em>soap-interface.php</em> (see <a class="el" href="model.html#generator_artefacts_php">PHP Code</a>).</p>
<p>The following example shows the configuration of the SOAP interface in the <a class="el" href="gettingstarted.html#app">default application</a>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Routes]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;/soap = action=soapAction</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;[ActionMapping]</div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;??soapAction = wcmf\application\controller\SOAPController</div>
</div><!-- fragment --><p>The <code>Routes</code> configuration section defines that the url <em>/soap</em> redirects to the action <em>soapAction</em> internally. The <code>ActionMapping</code> section defines that this action is handled by <a class="el" href="classwcmf_1_1application_1_1controller_1_1_s_o_a_p_controller.html"><code>SOAPController</code></a>. The interface description is available at the url <em>/soap?wsdl</em>.</p>
<h2><a class="anchor" id="pres_caching"></a>
Caching</h2>
<p>Caching is an effective method to improve application performance. Caches in wCMF are supposed to be divided into sections, which hold key-value pairs (see <a class="el" href="interfacewcmf_1_1lib_1_1io_1_1_cache.html"><code>Cache</code></a> interface). Cache instances may be defined in the application configuration and retrieved by using <a class="el" href="classwcmf_1_1lib_1_1core_1_1_object_factory.html"><code>ObjectFactory</code></a>, which makes it easy to exchange the underlying caching implementation.</p>
<p>The following example shows the configuration of a <a class="el" href="classwcmf_1_1lib_1_1io_1_1impl_1_1_file_cache.html"><code>FileCache</code></a> instance in the <a class="el" href="gettingstarted.html#app">default application</a>:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Cache]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;__class = wcmf\lib\io\impl\FileCache</div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;cacheDir = app/cache/</div>
</div><!-- fragment --><p>The usage of this cache is illustrated in the code example:</p>
<div class="fragment"><div class="line">$cache = ObjectFactory::getInstance(<span class="stringliteral">&#39;cache&#39;</span>);</div>
<div class="line">$cacheSection = <span class="stringliteral">&#39;calculations&#39;</span>;</div>
<div class="line"></div>
<div class="line">$cacheKey = <span class="stringliteral">&#39;resultA&#39;</span>;</div>
<div class="line"><span class="keywordflow">if</span> (!$cache-&gt;exists($cacheSection, $cacheKey)) {</div>
<div class="line">  <span class="comment">// calculate the result and store it in the cache</span></div>
<div class="line">  $result = complexCalculationA();</div>
<div class="line">  $cache-&gt;put($cacheSection, $cacheKey, $value);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">else</span> {</div>
<div class="line">  <span class="comment">// retrieve the result from the cache</span></div>
<div class="line">  $resultA = $cache-&gt;get($cacheSection, $cacheKey);</div>
<div class="line">}</div>
</div><!-- fragment --><p>Supposed that <code>complexCalculationA</code> in this example takes long to finish, it should only run once at the first time the result is needed. So we check if <em>resultA</em> is already cached and calculate it, if not. Since it is put it into the cache after calculation, it can be retrieved <em>resultA</em> directly from there the next time it is needed.</p>
<h2><a class="anchor" id="pres_events"></a>
Events</h2>
<p>Events are a way to decouple parts of a software by introducing an indirect communication. They allow clients to react to certain application events without the event source knowing them. wCMF uses the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">publish-subscribe</a> messaging pattern, in which <a class="el" href="interfacewcmf_1_1lib_1_1core_1_1_event_manager.html"><code>EventManager</code></a> acts as the message broker. Subscribers use this class to register for certain <a class="el" href="classwcmf_1_1lib_1_1core_1_1_event.html"><code>Event</code></a> types and publishers to send the events.</p>
<p>The following events are defined in wCMF:</p>
<ul>
<li><a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_persistence_event.html"><code>PersistenceEvent</code></a> is sent whenever a <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html"><code>PersistentObject</code></a> instance is created, updated or deleted.</li>
<li><a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_property_change_event.html"><code>PropertyChangeEvent</code></a>, <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_value_change_event.html"><code>ValueChangeEvent</code></a> and <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_state_change_event.html"><code>StateChangeEvent</code></a> signal changes in <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html"><code>PersistentObject</code></a> instances.</li>
<li><a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application_event.html"><code>ApplicationEvent</code></a> allows to listen to the different steps of the request handling process.</li>
</ul>
<p>The event system may be extended by custom events by inheriting from the <a class="el" href="classwcmf_1_1lib_1_1core_1_1_event.html"><code>Event</code></a> class.</p>
<p>The class below is a basic example for a listener that subscribes to persistence events:</p>
<div class="fragment"><div class="line"><span class="keyword">class </span>PersistenceEventListener {</div>
<div class="line">  <span class="keyword">private</span> $_eventListener = null;</div>
<div class="line"></div>
<div class="line">  <span class="keyword">public</span> <span class="keyword">function</span> __construct(EventListener $eventListener) {</div>
<div class="line">    $this-&gt;_eventListener = $eventListener;</div>
<div class="line">    $this-&gt;_eventListener-&gt;addListener(PersistenceEvent::NAME,</div>
<div class="line">      array($this, <span class="stringliteral">&#39;persisted&#39;</span>));</div>
<div class="line">  }</div>
<div class="line"></div>
<div class="line">  <span class="keyword">public</span> <span class="keyword">function</span> __destruct() {</div>
<div class="line">    $this-&gt;_eventListener-&gt;removeListener(PersistenceEvent::NAME,</div>
<div class="line">      array($this, <span class="stringliteral">&#39;persisted&#39;</span>));</div>
<div class="line">  }</div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">  /**</span></div>
<div class="line"><span class="comment">     Listen to PersistenceEvent</span></div>
<div class="line"><span class="comment">     @param $event PersistenceEvent instance</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  <span class="keyword">public</span> <span class="keyword">function</span> persisted(PersistenceEvent $event) {</div>
<div class="line">    <span class="comment">// do something on any create/update/delete</span></div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>To prevent memory leaks the <a class="el" href="interfacewcmf_1_1lib_1_1core_1_1_event_manager.html#ab5e39bf61897e33f13685e95c428e0bb"><code>EventManager::removeListener</code></a> method <b>must</b> be called, if the event listener is destroyed.</dd></dl>
<p>To send a persistence event, the following code is used:</p>
<div class="fragment"><div class="line">$eventListener = ObjectFactory::getInstance(<span class="stringliteral">&#39;eventManager&#39;</span>);</div>
<div class="line">$eventListener-&gt;dispatch(PersistenceEvent::NAME,</div>
<div class="line">        <span class="keyword">new</span> PersistenceEvent($object, PersistenceAction::UPDATE));</div>
</div><!-- fragment --><h3><a class="anchor" id="pres_listeners"></a>
Implicit listener installation</h3>
<p>In some cases you may want to install event listeners without explicitely instantiating them, because there is no appropriate place for that. For these cases the <a class="el" href="classwcmf_1_1lib_1_1presentation_1_1_application.html"><code>Application</code></a> class reads the <code>listeners</code> value of the <code>Application</code> configuration section and initializes all instances listed there.</p>
<p>The <a class="el" href="gettingstarted.html#app">default application</a> defines two listeners as shown in the following example:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;[Application]</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;listeners = {Search, EventListener}</div>
</div><!-- fragment --><p>Each entry in the <code>listeners</code> array is supposed to refer to an instance configuration (see <a class="el" href="configuration.html#conf_di">Dependency injection</a>).</p>
<h2><a class="anchor" id="pres_log"></a>
Logging</h2>
<p>wCMF integrates the logging frameworks <a href="http://logging.apache.org/log4php/">log4php</a> and <a href="https://github.com/Seldaek/monolog">Monolog</a>. To abstract from these libraries wCMF defines the <a class="el" href="interfacewcmf_1_1lib_1_1core_1_1_logger.html"><code>Logger</code></a> interface and implementations for each framework. The decision, which framework to use is made by instantiating the appropriate <a class="el" href="interfacewcmf_1_1lib_1_1core_1_1_logger.html"><code>Logger</code></a> instance and passing it to the <a class="el" href="classwcmf_1_1lib_1_1core_1_1_log_manager.html#aa84fc26d8447e732bc9b71ec954e2b7a"><code>LogManager::configure</code></a> method as shown for <em>Monolog</em> in the following example:</p>
<div class="fragment"><div class="line">$logger = <span class="keyword">new</span> MonologFileLogger(<span class="stringliteral">&#39;main&#39;</span>, WCMF_BASE.<span class="stringliteral">&#39;app/config/log.ini&#39;</span>);</div>
<div class="line">LogManager::configure($logger);</div>
</div><!-- fragment --><p>Afterwards <a class="el" href="interfacewcmf_1_1lib_1_1core_1_1_logger.html"><code>Logger</code></a> instances can be retrieved using the following code:</p>
<div class="fragment"><div class="line">$logger = LogManager::getLogger(__CLASS__);</div>
</div><!-- fragment --><p>The parameter used in the <a class="el" href="classwcmf_1_1lib_1_1core_1_1_log_manager.html#a0c195d83bf1cd47fb46a428e77f82b08"><code>LogManager::getLogger</code></a> method is the <em>logger name</em>. It's a good practice to use the <code>__CLASS__</code> constant as logger name, since this allows to enable/disable loggers by class names in the configuration (see <a class="el" href="configuration.html#conf_logging">Logging configuration</a>).</p>
<p>The following example shows how to log an error message with a stack trace appended (see <a class="el" href="classwcmf_1_1lib_1_1core_1_1_error_handler.html#afac334117f677949dc59de17ccb4ff7e"><code>ErrorHandler::getStackTrace</code></a>):</p>
<div class="fragment"><div class="line">$logger-&gt;error(<span class="stringliteral">&quot;An error occured.\n&quot;</span>.ErrorHandler::getStackTrace());</div>
</div><!-- fragment --> </div></div><!-- contents -->
<!-- start footer part -->
      </div>
    </div>
  </div>
</div>
<hr>
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <small>&copy; 2016 <a href="http://www.wemove.com" target="_blank">wemove digital solutions</a><br>
          Generated on Fri Jul 15 2016 22:20:41 for wCMF by &#160;<a href="http://www.doxygen.org/index.html" target="_blank">doxygen</a> 1.8.10</small>
      </div>
    </div>
  </div>
</footer>
</body>
</html>
