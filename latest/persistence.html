<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>wCMF 4.1: Persistence</title>
  <meta name="generator" content="Doxygen 1.8.17"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A MDSD framework for building reliable, maintainable and extendable web applications with PHP">
  <meta name="keywords" content="PHP, web application framework, model driven development">
  <meta name="author" content="wemove digital solutions">
  <link rel="shortcut icon" href="theme/images/favicon.ico">
  <script src="jquery.js"></script>
  <script src="theme/vendor/popper/popper.min.js"></script>
  <script src="theme/vendor/bootstrap/js/bootstrap.min.js"></script>
  <link href="theme/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="theme/vendor/fontawesome/css/all.min.css" rel="stylesheet">
  <script src="theme/vendor/bootstrap-toc/bootstrap-toc.min.js"></script>
  <link href="theme/vendor/bootstrap-toc/bootstrap-toc.min.css" rel="stylesheet">
  <script src="theme/vendor/bootstrap3-typeahead/bootstrap3-typeahead.min.js"></script>
  <script src="theme/vendor/highlight/highlight.pack.js"></script>
  <link href="theme/vendor/highlight/styles/solarized-dark.css" rel="stylesheet">
  <script src="theme/js/application.js"></script>
  <script src="dynsections.js"></script>
  <link href="theme/css/style.css" rel="stylesheet">
</head>
<body data-spy="scroll" data-target="#toc">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
  <a class="navbar-brand" href="index.html">wCMF 4.1</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggler" aria-controls="navbarToggler" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarToggler">
    <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="guidesDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="far fa-hand-point-right"></i> Guides <b class="caret"></b>
        </a>
        <div class="dropdown-menu" aria-labelledby="guidesDropdownMenuLink">
          <a class="dropdown-item" href="gettingstarted.html">Getting started</a>
          <a class="dropdown-item" href="architecture.html">Architecture</a>
          <a class="dropdown-item" href="model.html">Model</a>
          <a class="dropdown-item" href="persistence.html">Persistence</a>
          <a class="dropdown-item" href="presentation.html">Presentation</a>
          <a class="dropdown-item" href="configuration.html">Configuration</a>
          <a class="dropdown-item" href="security.html">Security</a>
          <a class="dropdown-item" href="i18n_l10n.html">I18n & l10n</a>
          <a class="dropdown-item" href="tests.html">Tests</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="versionsDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-tags"></i> Versions <b class="caret"></b>
        </a>
        <div class="dropdown-menu" aria-labelledby="versionsDropdownMenuLink">
          <a class="dropdown-item" href="4.1/index.html">4.1.x</a>
          <a class="dropdown-item" href="4.0/index.html">4.0.x</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="#" id="apiDropdownMenuLink" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <i class="fas fa-file-alt"></i> API <b class="caret"></b>
        </a>
        <div class="dropdown-menu" aria-labelledby="apiDropdownMenuLink">
          <a class="dropdown-item" href="annotated.html">Classes</a>
          <a class="dropdown-item" href="hierarchy.html">Hierarchy</a>
        </div>
      </li>
      <li class="nav-item"><a class="nav-link" href="https://github.com/iherwig/wcmf"><i class="fab fa-github"></i> Code</a></li>
      <li class="nav-item"><a class="nav-link" href="support.html"><i class="fas fa-life-ring"></i> Support</a></li>
    </ul>
    <form class="form-inline my-2 my-lg-0">
      <input id="search-field" class="form-control mr-sm-2" type="search" placeholder="Search API" disabled>
    </form>
  </div>
</nav>
<a class="anchor" id="top"></a>
<div class="content" id="content">
  <div class="container">
    <div class="row mt-4">
      <div id="toc-container" class="col-lg-3 d-none d-lg-block d-none">
        <nav id="toc" class="sticky-top"></nav>
      </div>
      <div id="content-container" class="col-md-12 col-lg-12">
        <div>
<!-- end header part --><!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
//var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Persistence </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="has-toc"></div><h1><a class="anchor" id="pers_main"></a>
Persistence</h1>
<p>Persistence refers to that part of the domain model, which we could call the data model.</p>
<h2><a class="anchor" id="pers_datamodel"></a>
Data model</h2>
<p>The data model consists of domain classes whose instances are saved in the storage. The following steps need to be accomplished to make domain class instances persistent.</p>
<ul>
<li>Definition and creation of the database tables, if using a database storage.</li>
<li>Implementation of the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_mapper.html"><code>PersistenceMapper</code></a> classes, which map the domain classes to these tables, or anything else that is used as storage.</li>
<li>Implementation of the domain classes as subclasses of <a class="el" href="classwcmf_1_1lib_1_1model_1_1_node.html"><code>Node</code></a>.</li>
<li>Configuration of the persistence layer.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>If you are using the generator to create the application from a model (see <a class="el" href="model.html">Model</a>), all necessary code will be generated automatically.</dd></dl>
<h3><a class="anchor" id="pers_tables"></a>
Database tables</h3>
<p>Still the most common storage for web applications is a <em>SQL</em> database (e.g. <a href="http://www.mysql.com/">MySQL</a>). It is also wCMF's default storage. Although not strictly necessary it is recommended to use one database table for each persistent class, where each class property maps to one table column and each row stores one instance. The object identity is stored in the primary key column, which is named <em>id</em> by default.</p>
<dl class="section note"><dt>Note</dt><dd>wCMF uses a table called <code>DBSequence</code> for retrieving the next id value used for insertion, since <em>autoincrement</em> columns are not supported on all database servers.</dd></dl>
<h4><a class="anchor" id="pers_id"></a>
Primary keys</h4>
<p>Primary keys are used to clearly identify an object in the database. They can consist of one (<em>simple</em>) or more (<em>compound</em>) columns. The default name for a primary key column is <em>id</em>. wCMF stores the primary key of an object together with it's type name in an <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_object_id.html"><code>ObjectId</code></a> instance.</p>
<h4><a class="anchor" id="pers_relations"></a>
Relations</h4>
<p>The following two relations types must be considered, when modeling the data tables:</p>
<ul>
<li><b>One-To-Many</b> relations are realized by adding a foreign key column to the child table (<em>many</em>-side), which points to the parent table (<em>one</em>-side). This column is named <em>fk</em> _ + parent table name + _ <em>id</em> by default (e.g. <em>fk_author_id</em>).</li>
<li><b>Many-To-Many</b> relations between two domain classes, are established by defining a connection table. This table contains two primary keys, which point to the two connected tables.</li>
</ul>
<h3><a class="anchor" id="pers_mappers"></a>
Persistence Mappers</h3>
<p>wCMF uses persistence mapper classes to communicate between the application and the persistent storage (see <a class="el" href="architecture.html#arch_main">Architecture</a>). These classes implement the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_mapper.html"><code>PersistenceMapper</code></a> interface, which defines methods for all persistence actions. By using this pattern wCMF does not make any assumptions about the actual storage, which can be flat files, a database, a remote service or anything else a mapper is able to handle. This approach also makes it easy to connect an existing storage to a newly created wCMF application.</p>
<p>To simplify the implementation of mapper classes, wCMF already contains a class hierarchy for a common mapping approach, which maps each concrete class to one database table (<a href="http://martinfowler.com/eaaCatalog/concreteTableInheritance.html">Concrete Table Inheritance</a>). In this hierarchy <a class="el" href="classwcmf_1_1lib_1_1model_1_1mapper_1_1impl_1_1_abstract_r_d_b_mapper.html"><code>AbstractRDBMapper</code></a> handles the communication with the relational database, while <a class="el" href=""><code>NodeUnifiedRDBMapper</code></a> defines the actual mapping rules. Application developers simply need to implement one subclass of <a class="el" href=""><code>NodeUnifiedRDBMapper</code></a> for each persistent domain class, which declares the mapping of the attributes and relations of that class.</p>
<dl class="section note"><dt>Note</dt><dd>All mapper classes, that are created by the generator are <a class="el" href=""><code>NodeUnifiedRDBMapper</code></a> subclasses.</dd></dl>
<h3><a class="anchor" id="pers_classes"></a>
Domain Classes</h3>
<p>Domain class instances hold the data that are used in the application and persisted in the storage.</p>
<p>Persistent domain classes either inherit from</p><ul>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html"><code>PersistentObject</code></a>, which is a container with value getter and setter methods, or from</li>
<li><a class="el" href="classwcmf_1_1lib_1_1model_1_1_node.html"><code>Node</code></a>, which adds methods for managing relations.</li>
</ul>
<p>These two classes are completely generic, the actual identity of the domain class - that is the <em>properties</em> and the <em>relations</em> - are defined by the related <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_mapper.html"><code>PersistenceMapper</code></a>.</p>
<p>So if no additional domain logic is required in the domain class, it would be sufficient to use <a class="el" href="classwcmf_1_1lib_1_1model_1_1_node.html"><code>Node</code></a> as domain class. But in many cases you will want to execute custom code for <a class="el" href="persistence.html#pers_hooks">Persistence Hooks</a>, <a class="el" href="persistence.html#pers_validation">Validation</a> and other business logic and therefor create a custom subclass of <a class="el" href="classwcmf_1_1lib_1_1model_1_1_node.html"><code>Node</code></a>.</p>
<dl class="section note"><dt>Note</dt><dd>All domain classes, that are created by the generator are <a class="el" href="classwcmf_1_1lib_1_1model_1_1_node.html"><code>Node</code></a> subclasses.</dd></dl>
<h4><a class="anchor" id="pers_hooks"></a>
Persistence Hooks</h4>
<p>Persistence hooks are methods that are called at certain points of the lifecycle of an instance. The default implementation of these methods is empty - in fact their sole purpose is to be overwritten in subclasses on order to implement special functionality that should be executed at those points. <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html"><code>PersistentObject</code></a> defines the following persistence hooks:</p>
<ul>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#acfb42c80e11f54475303ae3a58a33994"><code>afterCreate</code></a></li>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#aa6c147a602f20f3527d8607186fa253f"><code>beforeInsert</code></a></li>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a4a7f9241f789f5326d4213c9097437cf"><code>afterInsert</code></a></li>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#afc96ce03b1c876abdaafc59a03b3e9ff"><code>afterLoad</code></a></li>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a70a4db65b19348b3903ae88a82baee62"><code>beforeUpdate</code></a></li>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#afae845016f4e0f43e4214a22d3567b73"><code>afterUpdate</code></a></li>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a9439df4bc17e08751f6571b30397c340"><code>beforeDelete</code></a></li>
<li><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a39a8bcc2a5e284c64b58c3e2b6ddea81"><code>afterDelete</code></a></li>
</ul>
<h4><a class="anchor" id="pers_values"></a>
Values, Properties and Tags</h4>
<p>The following terms are important to know when working with wCMF's domain classes:</p>
<ul>
<li><b>Values</b> are the persistent attributes of a domain class. You can think of them as class members. Values are accessed using the methods <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a8c584efa272687554bd9abe5e83fe10c"><code>getValue</code></a> and <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a838057c0748db6d0db1d38fe5d06ef6b"><code>setValue</code></a>.</li>
<li><b>Properties</b> apply to domain classes and domain class values. They describe static features like the <code>displayValues</code> of the class or the <code>inputType</code> of a value. Properties are defined in the model as <em>tags</em> (see <a class="el" href="model.html#model_profile">Chronos profile</a>) and are accessed using the methods <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#aa54d71e15bac85c5f7a13e62b9933652"><code>getProperty</code></a>/ <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#aec9a68c84f392b3ae74cd70d552562b0"><code>setProperty</code></a> and <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a095af4f09e7aa62ba45e94a35c047c1d"><code>getValueProperty</code></a>/ <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#ad97867d143202b45bd320c16258c5f3c"><code>setValueProperty</code></a></li>
<li><b>Tags</b> are a special property used on values to group them by certain aspects. For example the edit forms in the <a class="el" href="gettingstarted.html#app">default application</a> only display domain class values that are tagged with <code>DATATYPE_ATTRIBUTE</code> and only those attributes are editable in the translation form that are tagged with <code>TRANSLATABLE</code>. The <code>SEARCHABLE</code> tag defines that an entity type should be included in the search index. Tags are defined in the model using the <em>tag</em> <code>app_data_type</code> (see <a class="el" href="model.html#model_chivalue">ChiValue</a>).</li>
</ul>
<h3><a class="anchor" id="pers_config"></a>
Configuration</h3>
<p>Entry point of configuring the persistence layer is <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html"><code>PersistenceFacade</code></a> (see <a class="el" href="persistence.html#pers_usage">Usage</a>). The configuration mainly tells the facade which mapper classes are responsible for which domain classes. This assignment is defined in the <code>TypeMapping</code> configuration section. The following example shows the appropriate entries for the <code>Author</code> domain class:</p>
<div class="ini"> <div class="fragment"><div class="line">[PersistenceFacade]</div>
<div class="line">__class = wcmf\lib\persistence\impl\DefaultPersistenceFacade</div>
<div class="line">mappers = $typeMapping</div>
<div class="line">logging = <span class="keyword">false</span></div>
<div class="line">logStrategy = $auditingLogStragegy</div>
<div class="line"> </div>
<div class="line">[AuditingLogStragegy]</div>
<div class="line">__class = wcmf\lib\persistence\output\impl\AuditingOutputStrategy</div>
<div class="line"> </div>
<div class="line">[TypeMapping]</div>
<div class="line">app.src.model.Author = $app_src_model_AuthorRDBMapper</div>
<div class="line"> </div>
<div class="line">[app_src_model_AuthorRDBMapper]</div>
<div class="line">__class = app\src\model\AuthorRDBMapper</div>
<div class="line">connectionParams = $database</div>
<div class="line"> </div>
<div class="line">[Database]</div>
<div class="line">dbType = sqlite</div>
<div class="line">dbHostName = 127.0.0.1</div>
<div class="line">dbName = app/test-db.sq3</div>
<div class="line">dbUserName =</div>
<div class="line">dbPassword =</div>
<div class="line">dbCharSet = utf8</div>
</div><!-- fragment --></div><div class="ini"></div><h2><a class="anchor" id="pers_usage"></a>
Usage</h2>
<p><a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html"><code>PersistenceFacade</code></a> is the main entry point to the persistence layer. It is used to create and retrieve <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html"><code>PersistentObject</code></a> instances. The following sections show some basic examples for using the persistence layer.</p>
<h3><a class="anchor" id="pers_load"></a>
Loading objects</h3>
<p>To load a <b>single object</b>, the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html#a90b99cef8752ebb13eb49a1005a251ec"><code>PersistenceFacade::load</code></a> method is used:</p>
<div class="php"> <div class="fragment"><div class="line">$oid = <span class="keyword">new</span> ObjectId(<span class="stringliteral">&#39;Author&#39;</span>, 1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// load the Author instance with id 1</span></div>
<div class="line">$author = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>)-&gt;load($oid);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// PersistenceFacade will return null, if an instance does not exist</span></div>
<div class="line"><span class="keywordflow">if</span>($author == <span class="keyword">null</span>) {</div>
<div class="line">  echo(<span class="stringliteral">&quot;An Author with object id &quot;</span>.$oid.<span class="stringliteral">&quot; does not exist.&quot;</span>);</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div><p>In the example the <code>Author</code> instance with id <em>1</em> is loaded.</p>
<p>A <b>list of objects</b> is loaded using the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html#afc20fc0561ad9718e0da1a8cd3adb846"><code>PersistenceFacade::loadObjects</code></a> method:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// load all Author instances</span></div>
<div class="line">$authors = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>)-&gt;loadObjects(<span class="stringliteral">&#39;Author&#39;</span>);</div>
</div><!-- fragment --></div><div class="php"></div><p>This <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html#afc20fc0561ad9718e0da1a8cd3adb846"><code>PersistenceFacade::loadObjects</code></a> method provides several parameters that allow to specify which instances should be loaded and how the list should be ordered. The next sections explain these parameters.</p>
<h4><a class="anchor" id="pers_builddepth"></a>
Eager relation loading</h4>
<p>When loading objects we generally distinguish between <b>eager</b> and <b>lazy</b> loading (see <a href="http://en.wikipedia.org/wiki/Lazy_loading">Lazy loading</a>). By default <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html"><code>PersistenceFacade</code></a> performs <em>lazy loading</em> by using <em>virtual proxies</em> (instances of <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_persistent_object_proxy.html"><code>PersistentObjectProxy</code></a>). That means that related objects are retrieved from the store, only when they are actually accessed. To perform <em>eager loading</em>, a <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_build_depth.html"><code>BuildDepth</code></a> value is passed in the method calls:</p>
<div class="php"> <div class="fragment"><div class="line">$oid = <span class="keyword">new</span> ObjectId(<span class="stringliteral">&#39;Author&#39;</span>, 1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// load the Author instance with id 1 together with all related objects</span></div>
<div class="line">$author = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>)-&gt;load($oid, BuildDepth::INFINITE);</div>
</div><!-- fragment --></div><div class="php"></div><p>In this example the <code>Author</code> instance with id <em>1</em> is loaded together with all related objects recursively.</p>
<p>Instead of a <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_build_depth.html"><code>BuildDepth</code></a> value, an integer number could be passed indicating the depth of relations to load. The following image illustrates the <em>build depth</em> parameter for a simple model.</p>
<div class="image">
<img src="builddepth.png" alt=""/>
<div class="caption">
Build depth</div></div>
<p>If using a build depth value of <em>1</em> the <code>Author</code> instance <em>Author A</em> will be loaded together with it's related <code>Articles</code> instances (<em>Article A</em>, <em>Article B</em>). A value of <em>2</em> will also load the <code>Chapter</code> instances (<em>Chapter A1</em>, <em>Chapter A2</em>). The default value is <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_build_depth.html#af33f2aced1762d825db23934d1b3205b"><code>BuildDepth::SINGLE</code></a>, which means that only the <em>Author A</em> instance is loaded. In the above illustration the value of <em>2</em> is equal to passing <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_build_depth.html#aa77abffeefb50083440c805c0fd76695"><code>BuildDepth::INFINITE</code></a>.</p>
<h4><a class="anchor" id="pers_sorting"></a>
Sorting</h4>
<p>When loading a list of objects, the default order of the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_mapper.html"><code>PersistenceMapper</code></a> class is used for sorting. This default order is defined in the model (<em>orderby</em> tag of <em>ChiNode</em>, see <a class="el" href="model.html#model_chinode">ChiNode / ChiManyToMany</a>). Besides this, all loading methods (e.g. <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html#afc20fc0561ad9718e0da1a8cd3adb846"><code>PersistenceFacade::loadObjects</code></a>) accept an <code>orderby</code> parameter for explicitly setting a different order.</p>
<p>A list of already loaded <a class="el" href="classwcmf_1_1lib_1_1model_1_1_node.html"><code>Node</code></a> instances is sorted by using <a class="el" href="classwcmf_1_1lib_1_1model_1_1_node_comparator.html"><code>NodeComparator</code></a> in the following way:</p>
<div class="php"> <div class="fragment"><div class="line">$nodeList = [...];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// set up a comparator for node type and created date</span></div>
<div class="line">$sortCriteria = [</div>
<div class="line">  NodeComparator::ATTRIB_TYPE =&gt; NodeComparator::SORTTYPE_ASC,</div>
<div class="line">  <span class="stringliteral">&#39;created&#39;</span> =&gt; NodeComparator::SORTTYPE_DESC</div>
<div class="line">];</div>
<div class="line">$comparator = <span class="keyword">new</span> NodeComparator($sortCriteria);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// sort node list</span></div>
<div class="line">usort($nodeList, [$comparator, <span class="stringliteral">&#39;compare&#39;</span>]);</div>
</div><!-- fragment --></div><div class="php"></div><h4><a class="anchor" id="pers_pagination"></a>
Pagination</h4>
<p>A common pattern for reducing the response time of an application when displaying large lists of objects is <a href="http://en.wikipedia.org/wiki/Pagination#Pagination_in_web_content">pagination</a>. This technique splits the list into smaller parts (<em>pages</em>) that are displayed one by one. In wCMF the class <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_paging_info.html"><code>PagingInfo</code></a> implements the concept.</p>
<p>The following code shows how to load <em>25</em> <code>Author</code> instances starting from position <em>50</em>:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// setup paging</span></div>
<div class="line">$pagingInfo = <span class="keyword">new</span> PagingInfo(25);</div>
<div class="line">$pagingInfo-&gt;setOffset(50);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// load Author instances</span></div>
<div class="line">$authors = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>)-&gt;loadObjects(<span class="stringliteral">&#39;Author&#39;</span>, BuildDepth::SINGLE, <span class="keyword">null</span>, <span class="keyword">null</span>, $pagingInfo);</div>
</div><!-- fragment --></div><div class="php"></div><p>Pagination is also possible over <b>multiple entity types</b>:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// setup paging</span></div>
<div class="line">$pagingInfo = <span class="keyword">new</span> PagingInfo(25);</div>
<div class="line">$pagingInfo-&gt;setOffset(50);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// load Author and Publisher instances ordered by creation date</span></div>
<div class="line">$types = [<span class="stringliteral">&#39;Author&#39;</span>, <span class="stringliteral">&#39;Publisher&#39;</span>];</div>
<div class="line">$order = [<span class="stringliteral">&#39;created&#39;</span>];</div>
<div class="line">$objects = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>)-&gt;loadObjects($types, BuildDepth::SINGLE, <span class="keyword">null</span>, $order, $pagingInfo);</div>
</div><!-- fragment --></div><div class="php"></div><h3><a class="anchor" id="pers_search"></a>
Searching objects</h3>
<p>To search objects in the store the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html#afc20fc0561ad9718e0da1a8cd3adb846"><code>PersistenceFacade::loadObjects</code></a> method is used. It allows to set the conditions that loaded objects should match.</p>
<div class="php"> <div class="fragment"><div class="line">$criteria = [</div>
<div class="line">  <span class="keyword">new</span> Criteria(<span class="stringliteral">&quot;Article&quot;</span>, <span class="stringliteral">&quot;title&quot;</span>, <span class="stringliteral">&quot;LIKE&quot;</span>, <span class="stringliteral">&quot;A%&quot;</span>),</div>
<div class="line">  <span class="keyword">new</span> Criteria(<span class="stringliteral">&quot;Article&quot;</span>, <span class="stringliteral">&quot;year&quot;</span>, <span class="stringliteral">&quot;&gt;=&quot;</span>, <span class="stringliteral">&quot;2014&quot;</span>)</div>
<div class="line">]</div>
<div class="line"> </div>
<div class="line"><span class="comment">// load all Article instances with titles starting with A and release date 2014 or later</span></div>
<div class="line">$articles = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>)-&gt;loadObjects(<span class="stringliteral">&quot;Article&quot;</span>, BuildDepth::SINGLE, $criteria);</div>
</div><!-- fragment --></div><div class="php"></div><p>In this example all <code>Article</code> instances with titles starting with <em>A</em> and release date <em>2014 or later</em> are loaded.</p>
<h4><a class="anchor" id="pers_search_null"></a>
Null values</h4>
<p>Null values are matched/not matched using the following criteria:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="keyword">new</span> Criteria(<span class="stringliteral">&quot;Article&quot;</span>, <span class="stringliteral">&quot;title&quot;</span>, <span class="stringliteral">&quot;=&quot;</span>, <span class="keyword">null</span>); <span class="comment">// translates to Article.title IS NULL</span></div>
<div class="line"><span class="keyword">new</span> Criteria(<span class="stringliteral">&quot;Article&quot;</span>, <span class="stringliteral">&quot;title&quot;</span>, <span class="stringliteral">&quot;!=&quot;</span>, <span class="keyword">null</span>); <span class="comment">// translates to Article.title IS NOT NULL</span></div>
</div><!-- fragment --></div><div class="php"></div><h4><a class="anchor" id="pers_search_object_queries"></a>
Object queries</h4>
<p>More complex use cases are supported by the <a class="el" href="classwcmf_1_1lib_1_1model_1_1_object_query.html"><code>ObjectQuery</code></a> class. For example it allows to set search constraints on connected objects as shown in the following example:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// create a Author query</span></div>
<div class="line">$query = <span class="keyword">new</span> ObjectQuery(<span class="stringliteral">&#39;Author&#39;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// query part: Author.name LIKE &#39;A%&#39; OR Author.name LIKE &#39;B%&#39;</span></div>
<div class="line">$authorTpl1 = $query-&gt;getObjectTemplate(<span class="stringliteral">&quot;Author&quot;</span>);</div>
<div class="line">$authorTpl1-&gt;setValue(<span class="stringliteral">&quot;name&quot;</span>, Criteria::asValue(<span class="stringliteral">&quot;LIKE&quot;</span>, <span class="stringliteral">&quot;A%&quot;</span>));</div>
<div class="line">$authorTpl2 = $query-&gt;getObjectTemplate(<span class="stringliteral">&quot;Author&quot;</span>, <span class="keyword">null</span>, Criteria::OPERATOR_OR);</div>
<div class="line">$authorTpl2-&gt;setValue(<span class="stringliteral">&quot;name&quot;</span>, Criteria::asValue(<span class="stringliteral">&quot;LIKE&quot;</span>, <span class="stringliteral">&quot;B%&quot;</span>));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// query part: Article.created &gt;= &#39;2004-01-01&#39; AND Article.created &lt; &#39;2005-01-01&#39;</span></div>
<div class="line">$articleTpl1 = $query-&gt;getObjectTemplate(<span class="stringliteral">&quot;Article&quot;</span>);</div>
<div class="line">$articleTpl1-&gt;setValue(<span class="stringliteral">&quot;created&quot;</span>, Criteria::asValue(<span class="stringliteral">&quot;&gt;=&quot;</span>, <span class="stringliteral">&quot;2004-01-01&quot;</span>));</div>
<div class="line">$articleTpl2 = $query-&gt;getObjectTemplate(<span class="stringliteral">&quot;Article&quot;</span>);</div>
<div class="line">$articleTpl2-&gt;setValue(<span class="stringliteral">&quot;created&quot;</span>, Criteria::asValue(<span class="stringliteral">&quot;&lt;&quot;</span>, <span class="stringliteral">&quot;2005-01-01&quot;</span>));</div>
<div class="line"> </div>
<div class="line"><span class="comment">// connect query nodes</span></div>
<div class="line">$authorTpl1-&gt;addNode($articleTpl1);</div>
<div class="line">$authorTpl1-&gt;addNode($articleTpl2);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// load result</span></div>
<div class="line">$authorList = $query-&gt;execute(BuildDepth::SINGLE);</div>
</div><!-- fragment --></div><div class="php"></div><p>In this example all <code>Author</code> instances are loaded which have names starting with <em>A</em> or <em>B</em> and which have <code>Article</code> instances connected that are created in the year <em>2014</em>.</p>
<p>It is possible to combine several object queries to apply pagination over <b>multiple entity types</b> using the <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1_union_query.html"><code>UnionQuery</code></a> class:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// create a Author query</span></div>
<div class="line">$authorQuery = <span class="keyword">new</span> ObjectQuery(<span class="stringliteral">&#39;Author&#39;</span>);</div>
<div class="line"><span class="comment">// ... define query</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// create a Publisher query</span></div>
<div class="line">$publisherQuery = <span class="keyword">new</span> ObjectQuery(<span class="stringliteral">&#39;Publisher&#39;</span>);</div>
<div class="line"><span class="comment">// ... define query</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// setup paging</span></div>
<div class="line">$pagingInfo = <span class="keyword">new</span> PagingInfo(25);</div>
<div class="line">$pagingInfo-&gt;setOffset(50);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// load Author and Publisher instances ordered by creation date</span></div>
<div class="line">$queryProvider = <span class="keyword">new</span> ObjectQueryUnionQueryProvider([$authorQuery, $publisherQuery]);</div>
<div class="line">$order = [<span class="stringliteral">&#39;created&#39;</span>];</div>
<div class="line">$objects = UnionQuery::execute($queryProvider, BuildDepth::SINGLE, $order, $pagingInfo);</div>
</div><!-- fragment --></div><div class="php"></div><p>Besides this, wCMF integrates the <a href="http://framework.zend.com/manual/1.12/en/zend.search.lucene.overview.html">Lucene</a> search engine in the class <a class="el" href="classwcmf_1_1lib_1_1search_1_1impl_1_1_lucene_search.html"><code>LuceneSearch</code></a>.</p>
<h3><a class="anchor" id="pers_iter"></a>
Iterating objects</h3>
<p>wCMF provides several <a href="http://php.net/manual/en/class.iterator.php">iterator</a> classes for traversing objects and values.</p>
<p><a class="el" href="classwcmf_1_1lib_1_1model_1_1_node_iterator.html"><code>NodeIterator</code></a> allows to traverse object graphs starting from a root <a class="el" href="classwcmf_1_1lib_1_1model_1_1_node.html"><code>Node</code></a>. The algorithm used is <a href="http://en.wikipedia.org/wiki/Depth-first_search">depth-first search</a>.</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// traverse $root and all descendents</span></div>
<div class="line">$it = <span class="keyword">new</span> NodeIterator($root);</div>
<div class="line"><span class="keywordflow">foreach</span>($it as $oid =&gt; $obj) {</div>
<div class="line">  echo <span class="stringliteral">&quot;current object id: $oid&quot;</span>;</div>
<div class="line">  echo <span class="stringliteral">&quot;current object: $obj&quot;</span>;</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div><p><a class="el" href="classwcmf_1_1lib_1_1model_1_1_node_value_iterator.html"><code>NodeValueIterator</code></a> is used to iterate over all persistent values of a <a class="el" href="classwcmf_1_1lib_1_1model_1_1_node.html"><code>Node</code></a>.</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// traverse all values of $object</span></div>
<div class="line">$it = <span class="keyword">new</span> NodeValueIterator($object);</div>
<div class="line"><span class="keywordflow">for</span>($it-&gt;rewind(); $it-&gt;valid(); $it-&gt;next()) {</div>
<div class="line">  echo <span class="stringliteral">&quot;current object: &quot;</span>.$it-&gt;currentNode();</div>
<div class="line">  echo <span class="stringliteral">&quot;current attribute name: &quot;</span>.$it-&gt;key();</div>
<div class="line">  echo <span class="stringliteral">&quot;current attribute value: &quot;</span>.$it-&gt;current();</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div><p><a class="el" href="classwcmf_1_1lib_1_1model_1_1_persistent_iterator.html"><code>PersistentIterator</code></a> allows to traverse object graphs as well, but it's state could be persisted to split the iteration of large lists into smaller parts.</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// traverse 10 nodes starting from $oid</span></div>
<div class="line">$counter = 0;</div>
<div class="line">$it = <span class="keyword">new</span> PersistentIterator($oid);</div>
<div class="line"><span class="keywordflow">while</span>($it-&gt;valid() &amp;&amp; $counter &lt; 10) {</div>
<div class="line">  echo <span class="stringliteral">&quot;current object: &quot;</span>.$it-&gt;currentNode();</div>
<div class="line">  $it-&gt;next();</div>
<div class="line">  $counter++;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// save iterator state in the session</span></div>
<div class="line">$iterId = $it-&gt;save();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// load the iterator state later and traverse the remaining nodes</span></div>
<div class="line">$it = PersistentIterator::load($iterId);</div>
<div class="line"><span class="keywordflow">while</span>($it-&gt;valid()) {</div>
<div class="line">  echo <span class="stringliteral">&quot;current object: &quot;</span>.$it-&gt;currentNode();</div>
<div class="line">  $it-&gt;next();</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div><h3><a class="anchor" id="pers_create_modify"></a>
Creating / Modifying objects</h3>
<p>Domain class instances are created by calling the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html#a2088197336092f89458036911a002bef"><code>PersistenceFacade::create</code></a> method or simply the class constructor, where the first approach is preferred over the second because it also sets the default values on attributes.</p>
<p>Changes on instances are persisted automatically, when the current transaction is committed (see <a class="el" href="persistence.html#pers_tx">Transactions</a>). Objects are removed from the store by calling the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a13bdffdd926f26b825ea57066334ff01"><code>PersistentObject::delete</code></a> method.</p>
<div class="php"> <div class="fragment"><div class="line">$persistenceFacade = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>);</div>
<div class="line">$tx = $persistenceFacade-&gt;getTransaction();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// create an Author instance</span></div>
<div class="line">$author = $persistenceFacade-&gt;create(<span class="stringliteral">&#39;Author&#39;</span>);</div>
<div class="line">$author-&gt;setValue(<span class="stringliteral">&#39;name&#39;</span>, <span class="stringliteral">&#39;Author A&#39;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// create an Article instance and attach it to the author</span></div>
<div class="line">$article = $persistenceFacade-&gt;create(<span class="stringliteral">&#39;Article&#39;</span>);</div>
<div class="line">$article-&gt;setValue(<span class="stringliteral">&#39;title&#39;</span>, <span class="stringliteral">&#39;Article A&#39;</span>);</div>
<div class="line">$author-&gt;addNode($article);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// save everything</span></div>
<div class="line">$tx-&gt;commit();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// get the author&#39;s object id</span></div>
<div class="line">$oid = $author-&gt;getOID()</div>
<div class="line"> </div>
<div class="line"><span class="comment">// delete the author instance</span></div>
<div class="line">$author = $persistenceFacade-&gt;load($oid);</div>
<div class="line">$author-&gt;delete();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// save everything</span></div>
<div class="line">$tx-&gt;commit();</div>
</div><!-- fragment --></div><div class="php"></div><h2><a class="anchor" id="pers_validation"></a>
Validation</h2>
<p>Before persisting objects, their content has to be validated according to the application requirements. Validation is handled in <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a1a79f61fa591ebe2550b187c1544e1d1"><code>PersistentObject::validateValue</code></a> (for a single attribute) or <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a27828d8e8c0fc9a21c24e2ed0d319a79"><code>PersistentObject::validateValues</code></a> (for the complete instance). These methods are called when values are changed via <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a838057c0748db6d0db1d38fe5d06ef6b"><code>PersistentObject::setValue</code></a> or right before persisting the object in <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1impl_1_1_abstract_mapper.html#aa39e50f302f70bdb719120f322d49cc6"><code>AbstractMapper::save</code></a>. Both validation methods throw a <a class="el" href=""><code>ValidationException</code></a>, if validation fails.</p>
<h3><a class="anchor" id="pers_validation_types"></a>
Validation types</h3>
<p>The actual validation is delegated to the <a class="el" href="classwcmf_1_1lib_1_1validation_1_1_validator.html#a53caf4e6a104095444452928dea631ad"><code>Validator::validate</code></a> method, which gets a <b>validation description string</b> passed. This string defines a single <a class="el" href="interfacewcmf_1_1lib_1_1validation_1_1_validate_type.html"><code>ValidateType</code></a> or a combination of those. The <a class="el" href="interfacewcmf_1_1lib_1_1validation_1_1_validate_type.html#af2ceef2ee3666226001c8566ff66718b"><code>ValidateType::validate</code></a> method accepts an associative array of configuration options, that is encoded into a JSON string when being used in the validation description string. An additional <b>validation context</b> might be passed to the method (e.g. the entity instance and the currently validated entity attribute), when validation entity values.</p>
<p>To define which validation should be applied to a domain class attribute, the <em>tag</em> <code>restrictions_match</code> is used in the model (see <a class="el" href="model.html#model_chivalue">ChiValue</a>).</p>
<p>Currently the following validation types exist (the examples show their usage in a validation description string):</p>
<p><a class="el" href="classwcmf_1_1lib_1_1validation_1_1impl_1_1_date.html"><code>Date</code></a> validates against a date format, e.g.</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// validate against the default date format (&#39;Y-m-d&#39;)</span></div>
<div class="line">date</div>
<div class="line"> </div>
<div class="line"><span class="comment">// validate against a custom date format (&#39;Y-m-d&#39;)</span></div>
<div class="line">date:{<span class="stringliteral">&quot;format&quot;</span>:<span class="stringliteral">&quot;j-M-Y&quot;</span>}</div>
</div><!-- fragment --></div><div class="php"></div><p><a class="el" href="classwcmf_1_1lib_1_1validation_1_1impl_1_1_filter.html"><code>Filter</code></a> validates against a PHP filter (see <a href="http://php.net/manual/en/function.filter-var.php">filter_var</a>), e.g.</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// FILTER_VALIDATE_INT with min_range option and FILTER_FLAG_ALLOW_HEX flag</span></div>
<div class="line">filter:{<span class="stringliteral">&quot;type&quot;</span>:<span class="stringliteral">&quot;int&quot;</span>,<span class="stringliteral">&quot;options&quot;</span>:{<span class="stringliteral">&quot;options&quot;</span>:{<span class="stringliteral">&quot;min_range&quot;</span>:0},<span class="stringliteral">&quot;flags&quot;</span>:2}}</div>
</div><!-- fragment --></div><div class="php"></div><p><a class="el" href="classwcmf_1_1lib_1_1validation_1_1impl_1_1_image.html"><code>Image</code></a> checks <em>width</em> and <em>height</em> of the referred image file e.g.</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// image width exactly 200px, height less than 100px</span></div>
<div class="line">image:{<span class="stringliteral">&quot;width&quot;</span>:[200,1],<span class="stringliteral">&quot;height&quot;</span>:[100,0]}</div>
</div><!-- fragment --></div><div class="php"></div><p><a class="el" href="classwcmf_1_1lib_1_1validation_1_1impl_1_1_reg_exp.html"><code>RegExp</code></a> validates against a regular expression (see <a href="http://php.net/manual/en/function.preg-match.php">preg_match</a>) e.g.</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// integer or empty</span></div>
<div class="line">regexp:{<span class="stringliteral">&quot;pattern&quot;</span>:<span class="stringliteral">&quot;/^[0-9]*$/&quot;</span>}</div>
</div><!-- fragment --></div><div class="php"></div><p><a class="el" href="classwcmf_1_1lib_1_1validation_1_1impl_1_1_required.html"><code>Required</code></a> checks if the value is not empty e.g.</p>
<div class="php"> <div class="fragment"><div class="line">required</div>
</div><!-- fragment --></div><div class="php"></div><p><a class="el" href="classwcmf_1_1lib_1_1validation_1_1impl_1_1_unique.html"><code>Unique</code></a> checks if the value is unique regarding the given entity attribute e.g.</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// explicitly define Keyword.name as being unique ...</span></div>
<div class="line">unique:{<span class="stringliteral">&quot;type&quot;</span>:<span class="stringliteral">&quot;Keyword&quot;</span>,<span class="stringliteral">&quot;value&quot;</span>:<span class="stringliteral">&quot;name&quot;</span>}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// ... or implicitly when used in the entity validation context of the Keyword.name</span></div>
<div class="line">unique</div>
</div><!-- fragment --></div><div class="php"></div><dl class="section note"><dt>Note</dt><dd>The validation type is derived from the part of the configuration string, that precedes the first colon.</dd></dl>
<p>Custom validation types can be added in the configuration. For example after adding <code>myValidator</code> (implemented in <code>MyValidator</code> class):</p>
<div class="ini"> <div class="fragment"><div class="line">[Validators]</div>
<div class="line">regexp = $regexpValidator</div>
<div class="line">filter = $filterValidator</div>
<div class="line">image = $imageValidator</div>
<div class="line">myValidator = $myValidator</div>
<div class="line"> </div>
<div class="line">[MyValidator]</div>
<div class="line">__class = path\to\MyValidator</div>
</div><!-- fragment --></div><div class="ini"></div><p>it is used in the following way:</p>
<div class="php"> <div class="fragment"><div class="line">myValidator:custom_configuration_string_passed_by_MyValidator</div>
</div><!-- fragment --></div><div class="php"></div><h3><a class="anchor" id="pers_validation_custom"></a>
Complex validation</h3>
<p>The described validation types only operate on one attribute. If more complex validation is required, e.g. if dependencies between several attributes exist, the method <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistent_object.html#a1a79f61fa591ebe2550b187c1544e1d1"><code>PersistentObject::validateValue</code></a> could be overriden in the appropriate domain class.</p>
<h2><a class="anchor" id="pers_concurrency"></a>
Concurrency</h2>
<p>When two or more users try to access the same object at the same time problems like <em>lost updates</em> might occur. These issues are avoided by <em>concurrency control</em> mechanisms, typically <em>object locking</em>.</p>
<h3><a class="anchor" id="pers_locking"></a>
Locking</h3>
<p>wCMF provides two locking strategies:</p>
<ul>
<li><b>Pessimistic locking</b>: An explicit lock is obtained by one user, that blocks write access to the object for other users until the lock is released.</li>
<li><b>Optimistic locking</b>: A copy of the initial object data is stored for each user and checked against later, when the user tries to store the object. The operation fails, if another user has updated the object data in the meantime.</li>
</ul>
<p>For more detailed information see <a href="http://en.wikipedia.org/wiki/Lock_%28computer_science%29#Database_locks">database locks</a>.</p>
<p><a class="el" href="classwcmf_1_1lib_1_1persistence_1_1concurrency_1_1_lock.html"><code>Lock</code></a> instances are obtained by calling <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1concurrency_1_1_concurrency_manager.html#af2587aae6d4b83240e4f2af303bedb67"><code>ConcurrencyManager::aquireLock</code></a> and released using <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1concurrency_1_1_concurrency_manager.html#a01b6b1a8d60d02ba834481c8f52a9052"><code>ConcurrencyManager::releaseLock</code></a> like shown in the following example:</p>
<div class="php"> <div class="fragment"><div class="line"><span class="comment">// object id of the object to lock</span></div>
<div class="line">$oid = <span class="keyword">new</span> ObjectId(<span class="stringliteral">&#39;Author&#39;</span>, 1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// aquire an optimistic lock for the object</span></div>
<div class="line">$lockType = Lock::TYPE_OPTIMISTIC;</div>
<div class="line">$concurrencyManager = ObjectFactory::getInstance(<span class="stringliteral">&#39;concurrencyManager&#39;</span>);</div>
<div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">  $concurrencyManager-&gt;aquireLock($oid, $lockType);</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span>(PessimisticLockException $ex) {</div>
<div class="line">  <span class="comment">// another user already holds a lock on this object</span></div>
<div class="line">  echo $ex-&gt;getMessage();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// release lock later</span></div>
<div class="line">$concurrencyManager-&gt;releaseLock($oid, $lockType);</div>
</div><!-- fragment --></div><div class="php"></div><p>The actual storage and retrieval of <a class="el" href="classwcmf_1_1lib_1_1persistence_1_1concurrency_1_1_lock.html"><code>Lock</code></a> instances is delegated to <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1concurrency_1_1_lock_handler.html"><code>LockHandler</code></a>. The following lines show the concurrency configuration in the <a class="el" href="gettingstarted.html#app">default application</a>:</p>
<div class="ini"> <div class="fragment"><div class="line">[ConcurrencyManager]</div>
<div class="line">__class = wcmf\lib\persistence\concurrency\impl\DefaultConcurrencyManager</div>
<div class="line">lockHandler = $lockHandler</div>
<div class="line"> </div>
<div class="line">[LockHandler]</div>
<div class="line">__class = wcmf\lib\persistence\concurrency\impl\DefaultLockHandler</div>
<div class="line">lockType = app.src.model.wcmf.Lock</div>
</div><!-- fragment --></div><div class="ini"></div><p>As you can see the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1concurrency_1_1_lock_handler.html"><code>LockHandler</code></a> implementation is exchangeable.</p>
<h2><a class="anchor" id="pers_tx"></a>
Transactions</h2>
<p>wCMF supports <a href="http://en.wikipedia.org/wiki/Database_transaction">database transactions</a>. There is only <b>one transaction at the same time</b> and it is be obtained using the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_persistence_facade.html#ac67a68804da2dfc9131f341f3659e578"><code>PersistenceFacade::getTransaction</code></a> method. The transaction has an <em>active</em> state, which is set in the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_transaction.html#a3a9793666e688407121d76d3a7e4db5d"><code>Transaction::begin</code></a> method and reset on commit or rollback.</p>
<p>The following example shows, how to use transactions:</p>
<div class="php"> <div class="fragment"><div class="line">$persistenceFacade = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// get the current transaction and start it</span></div>
<div class="line">$transaction = $persistenceFacade-&gt;getTransaction();</div>
<div class="line">$transaction-&gt;begin();</div>
<div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">  <span class="comment">// load the the Author instance with id 1 and make changes to it</span></div>
<div class="line">  $author = $persistenceFacade-&gt;load(<span class="keyword">new</span> ObjectId(<span class="stringliteral">&#39;Author&#39;</span>, 1));</div>
<div class="line">  $author-&gt;setValue(<span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Author B&quot;</span>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// save the changes</span></div>
<div class="line">  $transaction-&gt;commit();</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span>(Exception $ex) {</div>
<div class="line">  <span class="comment">// rollback the transaction if the commit fails</span></div>
<div class="line">  echo $ex-&gt;getMessage();</div>
<div class="line">  $transaction-&gt;rollback();</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div><dl class="section note"><dt>Note</dt><dd>Even if not obtained explicitely, there is always a transaction existing in the background, to which objects loaded from the store are attached. But to persist changes when doing a commit, the transaction has to be set <em>active</em> <em>before</em> loading or creating the object.</dd></dl>
<p>There are situations where you want to let the current transaction <b>ignore changes</b> made to newly created objects or objects loaded from the store. In these cases you can use the method <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_transaction.html#a8602b5996ccc25be7603f59f5b019ef5"><code>Transaction::detach</code></a> to disconnect the object from the transaction.</p>
<h3><a class="anchor" id="pers_tx_dry"></a>
Dry runs</h3>
<p>wCMF applies all database changes directly when committing the database transaction.</p>
<p>But there are situations where this is not desirable or just not possible. For example you might want to review the changes bevor applying them finally. Or the work to be done inside the transaction would exceed the provided resources (time and/or memory) and therefor must be split into smaller pieces but still need to be carried out in a one fails, all fail manner. A typical use case for the latter would be a large data import from external sources.</p>
<p>For these cases wCMF transactions offer the <a class="el" href="interfacewcmf_1_1lib_1_1persistence_1_1_transaction.html#aca2400ca914e964a60a69434b0168477"><code>Transaction::commitCollect</code></a> method, which returns all statements that would be executed, if the transaction would be commited regularly.</p>
<p>The following script shows how to do a dry run first and commit the collected statements later:</p>
<div class="php"> <div class="fragment"><div class="line">$persistenceFacade = ObjectFactory::getInstance(<span class="stringliteral">&#39;persistenceFacade&#39;</span>);</div>
<div class="line">$transaction = $this-&gt;persistenceFacade-&gt;getTransaction();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// create/modify/delete objects inside transaction</span></div>
<div class="line">$transaction-&gt;begin();</div>
<div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="comment">// dry run after finish</span></div>
<div class="line">$statements = $transaction-&gt;commitCollect();</div>
<div class="line"> </div>
<div class="line"><span class="comment">// apply collected statements to the database</span></div>
<div class="line"><span class="keywordflow">try</span> {</div>
<div class="line">  $transaction-&gt;begin();</div>
<div class="line">  $conn = $this-&gt;persistenceFacade-&gt;getMapper(<span class="stringliteral">&#39;Project&#39;</span>)-&gt;getConnection();</div>
<div class="line">  <span class="keywordflow">foreach</span> ($statements as $statement) {</div>
<div class="line">    list($stmt, $params) = $statement;</div>
<div class="line">    $conn-&gt;prepare($stmt)-&gt;execute($params);</div>
<div class="line">  }</div>
<div class="line">  $transaction-&gt;commit();</div>
<div class="line">}</div>
<div class="line"><span class="keywordflow">catch</span> (\Exception $ex) {</div>
<div class="line">  $transaction-&gt;rollback();</div>
<div class="line">}</div>
</div><!-- fragment --></div><div class="php"></div> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
      </div>
    </div>
  </div>
</div>
<hr>
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-9">
        <small>&copy; 2020 <a href="http://www.wemove.com" target="_blank">wemove digital solutions</a><br>
          Generated on Mon Dec 21 2020 22:40:28 for wCMF by &#160;<a href="http://www.doxygen.org/index.html" target="_blank">doxygen</a> 1.8.17</small>
      </div>
    </div>
  </div>
</footer>
<!-- Matomo -->
<script type="text/javascript">
  var _paq = _paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://piwik.wemove.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', '7']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><img src="https://piwik.wemove.com/piwik.php?idsite=7&rec=1" style="border:0" alt="" /></noscript>
<!-- End Matomo -->
</body>
</html>
